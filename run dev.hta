<html>
<head>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta charset="UTF-8">
    <title>PointMap Server Launcher</title>
    <HTA:APPLICATION
        ID="POINTMAP_SERVER_LAUNCHER"
        APPLICATIONNAME="PointMap Server Launcher"
        BORDER="dialog"
        BORDERSTYLE="normal"
        CAPTION="yes"
        MAXIMIZEBUTTON="no"
        MINIMIZEBUTTON="yes"
        SHOWINTASKBAR="yes"
        SINGLEINSTANCE="yes"
        SYSMENU="yes"
        SCROLL="no"
        WINDOWSTATE="normal"
    />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: #121212; 
            color: #e0e0e0;
            padding: 0; 
            overflow: hidden; 
            font-size: 13px; 
        }
        .container { 
            background-color: #1e1e1e; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        .header { 
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); 
            padding: 15px; 
            display: flex; 
            align-items: center; 
            color: white; 
            border-bottom: 1px solid #333;
        }
        .logo { 
            width: 50px; 
            height: 50px; 
            background: white; 
            border-radius: 50%; 
            padding: 4px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); 
            margin-right: 15px;
        }
        .header-text { display: flex; flex-direction: column; }
        h1 { font-size: 18px; font-weight: 800; margin: 0; color: white; line-height: 1.2; }
        .subtitle { font-size: 11px; opacity: 0.9; color: #bbdefb; }
        
        .content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        
        .server-card { 
            background-color: #2d2d2d; 
            border: 1px solid #424242; 
            border-radius: 8px; 
            padding: 10px; 
            margin-bottom: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); 
        }
        .server-card.running { border-left: 4px solid #4caf50; }
        .server-card.stopped { border-left: 4px solid #f44336; }
        .server-card.loading { border-left: 4px solid #ff9800; }
        
        .server-info { flex: 1; }
        .server-name { font-weight: 600; font-size: 14px; color: #ffffff; display: block; margin-bottom: 3px; }
        .server-status { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 4px; display: inline-block; }
        
        .status-running { background: #1b5e20; color: #a5d6a7; }
        .status-stopped { background: #b71c1c; color: #ffcdd2; }
        .status-loading { background: #e65100; color: #ffe0b2; }
        
        .btn-icon { 
            width: 32px; 
            height: 32px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 16px; 
            transition: all 0.2s; 
            background: #1565c0; 
            color: white; 
        }
        .btn-icon:hover { background: #1976d2; }

        .message-area { 
            margin-top: 10px; 
            padding: 8px; 
            background: #252525; 
            border-radius: 6px; 
            font-size: 11px; 
            color: #bdbdbd; 
            text-align: center; 
            border: 1px solid #333; 
            font-family: monospace;
        }

        .footer-controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
        }
        .btn-footer {
            background: #424242;
            color: white;
            border: 1px solid #616161;
            padding: 8px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        .btn-footer:hover { background: #616161; }
        .btn-restart { 
            background: #2e7d32; 
            border-color: #388e3c; 
            margin-left: 10px;
            margin-right: 10px;
        }
        .btn-restart:hover { background: #388e3c; }
        .btn-close { 
            background: #c62828; 
            border-color: #d32f2f; 
            margin-left: 10px;
        }
        .btn-close:hover { background: #d32f2f; }

        .terminal-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex: 1;
            min-height: 150px;
        }
        .terminal-box {
            flex: 1;
            background-color: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 0; /* Remove padding from container */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Hide overflow */
        }
        .terminal-title {
            color: #888;
            background: #111;
            border-bottom: 1px solid #333;
            padding: 5px 10px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 11px;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .terminal-content {
            flex: 1;
            padding: 10px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px; /* Increased font size */
            color: #ccc;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
    
    <script type="text/javascript">
        var shell = new ActiveXObject("WScript.Shell");
        var fso = new ActiveXObject("Scripting.FileSystemObject");
        
        // FORCE SET WORKING DIRECTORY (Fix untuk path relative)
        try {
            // Bersihkan path dari format URL (file:///...)
            var path = location.pathname.replace("file:///", "").replace(/\//g, "\\");
            path = decodeURIComponent(path); // Handle spasi (%20)
            var folder = fso.GetParentFolderName(path);
            shell.CurrentDirectory = folder;
        } catch(e) {}
        var backendRunning = false;
        var frontendRunning = false;
        var backendCheckInterval = null;
        var frontendCheckInterval = null;
        var logInterval = null;
        var isFirstRun = true; // Flag for first run

        function resizeWindow() {
            // Increased width slightly
            window.resizeTo(1000, 800);
            window.moveTo((screen.width - 1000) / 2, (screen.height - 800) / 2);
        }

        function updateUI(server, status, text) {
            var card = document.getElementById("card" + server);
            var statusSpan = document.getElementById("status" + server);
            
            if (card) card.className = "server-card " + status;
            if (statusSpan) {
                statusSpan.className = "server-status status-" + status;
                statusSpan.innerText = text;
            }
        }

        function updateMessage(msg) {
            document.getElementById("message").innerText = "> " + msg;
        }

        function readLogFile(path, elementId) {
            try {
                if (fso.FileExists(path)) {
                    var file = fso.OpenTextFile(path, 1, false);
                    var content = file.ReadAll();
                    file.Close();
                    
                    content = content.replace(/\x1b\[[0-9;]*m/g, "");
                    
                    var el = document.getElementById(elementId);
                    // Only update if content changed to avoid flickering/scroll jump
                    if (el.innerText !== content) {
                        el.innerText = content;
                        el.scrollTop = el.scrollHeight;
                    }
                }
            } catch(e) {}
        }

        function runBackend() {
            try {
                updateMessage("Stopping any existing Backend...");
                try { shell.Run("taskkill /F /IM node.exe /T", 0, true); } catch(e){}

                var cmd = 'cmd /c "cd backend && npm run dev > ..\\backend.log 2>&1"';
                shell.Run(cmd, 0, false);
                
                updateUI("Backend", "loading", "STARTING...");
                updateMessage("Backend starting...");
                
                if (backendCheckInterval) clearInterval(backendCheckInterval);
                checkServer("Backend", "http://localhost:3001");
            } catch (e) {
                updateUI("Backend", "stopped", "ERROR");
                updateMessage("Error starting Backend: " + e.message);
            }
        }

        function runFrontend() {
            try {
                var cmd = 'cmd /c "cd frontend && npm run dev > ..\\frontend.log 2>&1"';
                shell.Run(cmd, 0, false);
                
                updateUI("Frontend", "loading", "STARTING...");
                updateMessage("Frontend starting...");
                
                if (frontendCheckInterval) clearInterval(frontendCheckInterval);
                checkServer("Frontend", "http://localhost:3000");
            } catch (e) {
                updateUI("Frontend", "stopped", "ERROR");
                updateMessage("Error starting Frontend: " + e.message);
            }
        }

        function checkServer(server, url) {
            var attempts = 0;
            var maxAttempts = 60; 
            
            var interval = setInterval(function() {
                attempts++;
                try {
                    var xhr = new ActiveXObject("MSXML2.XMLHTTP");
                    xhr.open("GET", url, false);
                    xhr.send();
                    
                    if (xhr.status == 200 || xhr.status == 404) {
                        clearInterval(interval);
                        if (server === "Backend") {
                            backendRunning = true;
                            updateUI("Backend", "running", "RUNNING");
                            updateMessage("Backend is Ready!");
                            checkAutoOpen();
                        } else if (server === "Frontend") {
                            frontendRunning = true;
                            updateUI("Frontend", "running", "RUNNING");
                            updateMessage("Frontend is Ready!");
                            checkAutoOpen();
                        }
                    }
                } catch(e) { }

                if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    updateUI(server, "stopped", "TIMEOUT");
                    updateMessage(server + " timed out.");
                }
            }, 1000);

            if (server === "Backend") backendCheckInterval = interval;
            if (server === "Frontend") frontendCheckInterval = interval;
        }

        function checkAutoOpen() {
            if (backendRunning && frontendRunning) {
                updateMessage("All systems ready.");
                document.getElementById("cardBrowser").className = "server-card running";
                document.getElementById("statusBrowser").className = "server-status status-running";
                document.getElementById("statusBrowser").innerText = "READY";
                
                if (isFirstRun) {
                    updateMessage("First run: Opening browser...");
                    setTimeout(openBrowser, 1000);
                    isFirstRun = false;
                }
            }
        }

        function openBrowser() {
            try {
                shell.Run("http://localhost:3000");
                updateMessage("Browser opened.");
            } catch (e) {
                updateMessage("Error opening browser: " + e.message);
            }
        }

        function initApp() {
            resizeWindow();
            checkUpdate(true);
        }

        function checkUpdate(autoProceed) {
            updateUI("Update", "loading", "CHECKING...");
            updateMessage("Checking for updates...");
            
            setTimeout(function() {
                try {
                    var cmd = 'cmd /c "git pull > update.log 2>&1"';
                    shell.Run(cmd, 0, true);
                    
                    if (fso.FileExists("update.log")) {
                        var file = fso.OpenTextFile("update.log", 1);
                        var content = file.ReadAll();
                        file.Close();
                        
                        if (content.indexOf("Already up to date") !== -1) {
                            updateUI("Update", "running", "UP TO DATE");
                            updateMessage("System is up to date.");
                        } else if (content.indexOf("Updating") !== -1 || content.indexOf("Fast-forward") !== -1) {
                            updateUI("Update", "running", "UPDATED");
                            updateMessage("System updated successfully.");
                        } else {
                            updateUI("Update", "running", "CHECKED");
                            updateMessage("Update check completed.");
                        }
                    } else {
                         // Fallback if log not found
                         updateUI("Update", "stopped", "UNKNOWN");
                    }
                } catch(e) {
                    updateUI("Update", "stopped", "ERROR");
                    updateMessage("Update check failed: " + e.message);
                }
                
                if (autoProceed) {
                    setTimeout(startAll, 1000);
                }
            }, 100);
        }

        function startAll() {
            resizeWindow();
            updateMessage("Initializing...");
            
            try { fso.DeleteFile("backend.log"); } catch(e){}
            try { fso.DeleteFile("frontend.log"); } catch(e){}
            document.getElementById("termBackend").innerText = "";
            document.getElementById("termFrontend").innerText = "";

            backendRunning = false;
            frontendRunning = false;
            
            runBackend();
            setTimeout(function() {
                runFrontend();
            }, 2000);

            if (logInterval) clearInterval(logInterval);
            logInterval = setInterval(function() {
                readLogFile("backend.log", "termBackend");
                readLogFile("frontend.log", "termFrontend");
            }, 1000);
        }

        window.onbeforeunload = function(e) {
            var choice = shell.Popup("Apakah anda yakin ingin keluar?\nServer Backend dan Frontend akan dimatikan.", 0, "Konfirmasi Keluar", 36);
            if (choice == 6) {
                try {
                    shell.Run("taskkill /F /IM node.exe /T", 0, true);
                } catch(e) {}
            } else {
                return "Pembatalan keluar.";
            }
        };

        window.onunload = function() {
            try {
                shell.Run("taskkill /F /IM node.exe /T", 0, true);
                // Hapus file log saat keluar agar folder tetap bersih
                try { fso.DeleteFile("backend.log"); } catch(e){}
                try { fso.DeleteFile("frontend.log"); } catch(e){}
                try { fso.DeleteFile("update.log"); } catch(e){}
            } catch(e) {}
        };
    </script>
</head>
<body onload="initApp()">
    <div class="container">
        <div class="header">
            <div class="header-text">
                <h1>PointMap Server</h1>
                <div class="subtitle">Server Control Panel</div>
            </div>
        </div>
        <div class="content">
            <!-- Update Status Card -->
            <div class="server-card loading" id="cardUpdate">
                <div class="server-info">
                    <span class="server-name">System Update</span>
                    <span class="server-status status-loading" id="statusUpdate">CHECKING...</span>
                </div>
            </div>

            <!-- Backend Card -->
            <div class="server-card stopped" id="cardBackend">
                <div class="server-info">
                    <span class="server-name">Backend Server</span>
                    <span class="server-status status-stopped" id="statusBackend">STOPPED</span>
                </div>
            </div>

            <!-- Frontend Card -->
            <div class="server-card stopped" id="cardFrontend">
                <div class="server-info">
                    <span class="server-name">Frontend Server</span>
                    <span class="server-status status-stopped" id="statusFrontend">STOPPED</span>
                </div>
            </div>

            <!-- Browser Card -->
            <div class="server-card stopped" id="cardBrowser" style="border-left-color: #1976d2;">
                <div class="server-info">
                    <span class="server-name">Web Application</span>
                    <span class="server-status" id="statusBrowser" style="background: #1565c0; color: white;">http://localhost:3000</span>
                </div>
                <button class="btn-icon" onclick="openBrowser()" title="Open in Browser">&#8599;</button>
            </div>

            <div class="message-area" id="message">Ready...</div>
            
            <div class="footer-controls">
                <button class="btn-footer" onclick="checkUpdate(false)" style="margin-right: 10px;">Check Update</button>
                <button class="btn-footer btn-restart" onclick="startAll()">Restart All</button>
                <button class="btn-footer btn-close" onclick="window.close()">Close</button>
            </div>

            <div class="terminal-container">
                <div class="terminal-box">
                    <div class="terminal-title">Frontend Log</div>
                    <div class="terminal-content" id="termFrontend"></div>
                </div>
                <div class="terminal-box">
                    <div class="terminal-title">Backend Log</div>
                    <div class="terminal-content" id="termBackend"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
