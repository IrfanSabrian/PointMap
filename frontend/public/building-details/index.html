<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Detail Bangunan - PointMap</title>
    <meta
      name="description"
      content="Detail bangunan dengan informasi ruangan yang dinamis berdasarkan database"
    />
    <meta
      name="keywords"
      content="building map, 3d, css, javascript, pin, levels, floor map"
    />
    <meta name="author" content="PointMap" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <!-- Fancybox CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css"
    />
    <style>
      /* Modal Info Styles */
      .info-modal {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(0, 0, 0, 0.5) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 99999 !important;
        padding: 2rem !important;
        transform: none !important;
        perspective: none !important;
        transform-style: flat !important;
      }

      /* 2D View Styles - Inline for testing */
      .building.building--2d .surroundings,
      .building.building--2d .levels {
        -webkit-transform: none !important;
        transform: none !important;
      }

      .building.building--2d .level::after {
        -webkit-transform: none !important;
        transform: none !important;
        color: #515158 !important;
        font-weight: bold !important;
        top: -1em !important;
        left: 0 !important;
        text-align: center !important;
        width: 100% !important;
      }

      .building.building--2d .level--current::after {
        -webkit-transform: none !important;
        transform: none !important;
        color: #2c3e50 !important;
        font-weight: bold !important;
        top: -1em !important;
        width: 100% !important;
      }

      .building.building--2d .level--2,
      .building.building--2d .level--3,
      .building.building--2d .level--4 {
        -webkit-transform: none !important;
        transform: none !important;
      }

      .info-content {
        background: #fff !important;
        border-radius: 18px !important;
        box-shadow: 0 8px 32px 0 rgba(30, 41, 59, 0.18) !important;
        padding: 2.5rem !important;
        text-align: center !important;
        max-width: 500px !important;
        width: 100% !important;
        animation: fadeInModal 0.3s ease-out !important;
        position: relative !important;
        transform: none !important;
        perspective: none !important;
        transform-style: flat !important;
      }

      @keyframes fadeInModal {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .info-icon {
        font-size: 4rem;
        color: #3498db;
        margin-bottom: 1.5rem;
      }

      .info-title {
        font-size: 1.8rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 1rem;
        opacity: 1;
        transform: translateY(0);
        transition: all 0.4s ease-in-out;
      }

      .info-title.fade-out {
        opacity: 0;
        transform: translateY(-20px);
      }

      .info-title.fade-in {
        opacity: 1;
        transform: translateY(0);
      }

      .info-subtitle {
        font-size: 1.1rem;
        color: #34495e;
        margin-bottom: 1.5rem;
        line-height: 1.5;
        opacity: 1;
        transform: translateY(0);
        transition: all 0.4s ease-in-out;
      }

      .info-subtitle.fade-out {
        opacity: 0;
        transform: translateY(-20px);
      }

      .info-subtitle.fade-in {
        opacity: 1;
        transform: translateY(0);
      }

      .info-description {
        background: #f8f9fa;
        border-left: 4px solid #3498db;
        padding: 1.2rem;
        margin: 1.5rem 0;
        text-align: left;
        border-radius: 6px;
        opacity: 1;
        transform: translateY(0);
        transition: all 0.4s ease-in-out;
      }

      .info-description.fade-out {
        opacity: 0;
        transform: translateY(-20px);
      }

      .info-description.fade-in {
        opacity: 1;
        transform: translateY(0);
      }

      .info-description p {
        margin: 0.5rem 0;
        color: #555;
        font-size: 0.95rem;
        line-height: 1.6;
      }

      .info-actions {
        margin-top: 2rem;
      }

      .btn-close {
        background: #3498db;
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-close:hover {
        background: #2980b9;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
      }

      .btn-close:active {
        transform: translateY(0);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .info-modal {
          padding: 1rem;
        }

        .info-content {
          padding: 2rem;
          max-width: 90%;
        }

        .info-title {
          font-size: 1.5rem;
        }

        .info-subtitle {
          font-size: 1rem;
        }
      }

      /* Custom Notification System */
      .notification-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 999999;
        max-width: 400px;
        width: 90%;
        pointer-events: none;
      }

      .notification-container .notification {
        pointer-events: auto;
      }

      .notification {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        border-left: 4px solid;
        animation: slideDown 0.5s ease-in-out;
        transition: all 0.5s ease-in-out;
      }

      .notification.success {
        border-left-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
      }

      .notification.error {
        border-left-color: #ef4444;
        background: linear-gradient(135deg, #fef2f2 0%, #fef2f2 100%);
      }

      .notification-icon {
        font-size: 24px;
        flex-shrink: 0;
      }

      .notification.success .notification-icon {
        color: #10b981;
        animation: checkmark 0.6s ease-in-out;
      }

      .notification.error .notification-icon {
        color: #ef4444;
        animation: crossmark 0.6s ease-in-out;
      }

      .notification-content {
        flex: 1;
      }

      .notification-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 4px;
      }

      .notification.success .notification-title {
        color: #065f46;
      }

      .notification.error .notification-title {
        color: #991b1b;
      }

      .notification-message {
        font-size: 14px;
        color: #6b7280;
      }

      .notification.success .notification-message {
        color: #047857;
      }

      .notification.error .notification-message {
        color: #dc2626;
      }

      .notification-close {
        background: none;
        border: none;
        color: #6b7280;
        font-size: 18px;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .notification-close:hover {
        color: #374151;
        background: rgba(0, 0, 0, 0.05);
      }

      @keyframes slideDown {
        from {
          transform: translateX(-50%) translateY(-100%);
          opacity: 0;
        }
        to {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }
      }

      @keyframes checkmark {
        0% {
          transform: scale(0) rotate(-45deg);
          opacity: 0;
        }
        50% {
          transform: scale(1.2) rotate(-45deg);
          opacity: 1;
        }
        100% {
          transform: scale(1) rotate(0deg);
          opacity: 1;
        }
      }

      @keyframes crossmark {
        0% {
          transform: scale(0) rotate(45deg);
          opacity: 0;
        }
        50% {
          transform: scale(1.2) rotate(45deg);
          opacity: 1;
        }
        100% {
          transform: scale(1) rotate(0deg);
          opacity: 1;
        }
      }

      /* Debug Layer untuk menunjukkan area pin marker */
      .debug-pin-area {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 0, 0, 0.3);
        border: 2px solid rgba(255, 0, 0, 0.8);
        pointer-events: none;
        z-index: 1;
        display: none; /* Hidden by default */
        align-items: center;
        justify-content: center;
        font-family: monospace;
        font-size: 12px;
        color: rgba(255, 0, 0, 0.9);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      }

      /* Pin marker indicator in debug mode */
      .debug-pin-indicator {
        position: absolute;
        width: 12px;
        height: 12px;
        background: rgba(0, 255, 0, 0.9);
        border: 2px solid white;
        border-radius: 50%;
        pointer-events: none;
        z-index: 5;
        box-shadow: 0 0 8px rgba(0, 255, 0, 0.8);
        animation: pulse 2s infinite;
      }

      .debug-pin-indicator::after {
        content: attr(data-room);
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 255, 0, 0.9);
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: bold;
        white-space: nowrap;
        z-index: 6;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.2);
          opacity: 0.7;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .debug-pin-area.show {
        display: flex;
      }

      .debug-pin-area::before {
        content: "DEBUG: Area Pin Marker (0,0) sampai (100%,100%) - Safe Area: (5%,5%) sampai (95%,95%)";
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 0, 0, 0.9);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        max-width: 300px;
        white-space: normal;
        line-height: 1.2;
      }

      /* Safe area indicator */
      .debug-pin-area .safe-area {
        position: absolute;
        top: 5%;
        left: 5%;
        width: 90%;
        height: 90%;
        border: 2px dashed rgba(0, 255, 0, 0.8);
        background: rgba(0, 255, 0, 0.1);
        pointer-events: none;
      }

      .debug-pin-area::after {
        content: "CENTER: X: 50% Y: 50%";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 0, 0, 0.9);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        white-space: nowrap;
      }

      /* Coordinate labels */
      .debug-pin-area .coord-label {
        position: absolute;
        background: rgba(255, 0, 0, 0.9);
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: bold;
        white-space: nowrap;
        pointer-events: none;
      }

      .debug-pin-area .coord-label.top-left {
        top: 15px;
        left: 15px;
      }

      .debug-pin-area .coord-label.top-right {
        top: 15px;
        right: 15px;
      }

      .debug-pin-area .coord-label.bottom-left {
        bottom: 15px;
        left: 15px;
      }

      .debug-pin-area .coord-label.bottom-right {
        bottom: 15px;
        right: 15px;
      }

      /* Grid lines untuk membantu positioning */
      .debug-pin-area .grid-line {
        position: absolute;
        background: rgba(255, 0, 0, 0.5);
        pointer-events: none;
      }

      .debug-pin-area .grid-line.horizontal {
        width: 100%;
        height: 1px;
      }

      .debug-pin-area .grid-line.vertical {
        width: 1px;
        height: 100%;
      }

      /* Corner markers */
      .debug-pin-area .corner-marker {
        position: absolute;
        width: 10px;
        height: 10px;
        background: rgba(255, 0, 0, 0.9);
        border: 2px solid white;
        border-radius: 50%;
      }

      .debug-pin-area .corner-marker.top-left {
        top: 5px;
        left: 5px;
      }

      .debug-pin-area .corner-marker.top-right {
        top: 5px;
        right: 5px;
      }

      .debug-pin-area .corner-marker.bottom-left {
        bottom: 5px;
        left: 5px;
      }

      .debug-pin-area .corner-marker.bottom-right {
        bottom: 5px;
        right: 5px;
      }

      /* Custom Confirmation Dialog */
      .confirmation-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .confirmation-modal.show {
        opacity: 1;
        visibility: visible;
      }

      .confirmation-content {
        background: white;
        border-radius: 16px;
        padding: 32px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        transform: scale(0.8);
        transition: transform 0.3s ease;
      }

      .confirmation-modal.show .confirmation-content {
        transform: scale(1);
      }

      .confirmation-icon {
        font-size: 48px;
        color: #f59e0b;
        margin-bottom: 16px;
      }

      .confirmation-title {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 12px;
      }

      .confirmation-message {
        font-size: 16px;
        color: #6b7280;
        margin-bottom: 24px;
        line-height: 1.5;
      }

      .confirmation-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .btn-confirm {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-confirm.cancel {
        background: #f3f4f6;
        color: #6b7280;
      }

      .btn-confirm.cancel:hover {
        background: #e5e7eb;
      }

      .btn-confirm.confirm {
        background: #ef4444;
        color: white;
      }

      .btn-confirm.confirm:hover {
        background: #dc2626;
      }

      /* Room Detail Layout Styles */
      .content__layout {
        display: flex;
        gap: 2rem;
        align-items: center;
        padding: 0 0.5rem;
        justify-content: center;
        max-width: 800px;
        margin: 0 auto;
      }

      .content__info {
        flex: 1;
        min-width: 0;
        padding-left: 0.5rem;
      }

      .content__image {
        flex-shrink: 0;
        width: 250px;
        height: 150px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        opacity: 0;
        transform: scale(0.95);
        transition: all 0.4s ease-in-out;
      }

      .content__image.fade-out {
        opacity: 0 !important;
        transform: scale(0.95) !important;
      }

      .content__image.fade-in {
        opacity: 1 !important;
        transform: scale(1) !important;
      }

      .room-thumbnail {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
        pointer-events: none;
      }

      .gallery-link:hover .room-thumbnail {
        transform: scale(1.05);
      }

      /* Gallery Styles */
      .room-gallery {
        position: relative;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .room-gallery a {
        display: block;
        width: 100%;
        height: 100%;
        text-decoration: none;
        position: relative;
        cursor: pointer;
      }

      .gallery-link {
        z-index: 10;
        position: relative;
        display: block;
        width: 100%;
        height: 100%;
      }

      .gallery-link:active {
        transform: scale(0.98);
      }

      .gallery-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        border-radius: 12px;
        pointer-events: none;
      }

      .gallery-link:hover .gallery-overlay {
        opacity: 1;
      }

      .gallery-indicator {
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .gallery-indicator i {
        font-size: 1.2rem;
        color: #3498db;
      }

      .gallery-count {
        font-size: 0.9rem;
      }

      /* Edit buttons styling */
      .content__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .edit-room-btn {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
        transition: all 0.2s ease;
        font-size: 20px;
      }

      .edit-room-btn:hover {
        color: #3498db;
        background: rgba(52, 152, 219, 0.1);
      }

      .gallery-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: block;
      }

      .gallery-container .gallery-link {
        display: block;
        width: 100%;
        height: 100%;
        text-decoration: none;
        position: relative;
      }

      .edit-gallery-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.6);
        border: none;
        color: white;
        cursor: pointer;
        padding: 6px;
        border-radius: 4px;
        transition: all 0.2s ease;
        font-size: 14px;
        z-index: 20;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .edit-gallery-btn:hover {
        color: #3498db;
        background: rgba(52, 152, 219, 0.8);
        transform: scale(1.1);
      }

      /* Modal Edit Styles - Redesigned */
      .edit-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        padding: 20px;
      }

      .edit-modal-content {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 600px;
        position: relative;
        overflow: hidden;
      }

      .edit-modal-header {
        background: #f8fafc;
        padding: 24px 30px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }

      .header-left h3 {
        margin: 0 0 8px 0;
        color: #1e293b;
        font-size: 20px;
        font-weight: 600;
      }

      .header-left p {
        margin: 0;
        color: #64748b;
        font-size: 14px;
        font-weight: 400;
      }

      .close-btn {
        background: #e2e8f0;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #475569;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s ease;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .close-btn:hover {
        background: #cbd5e1;
        color: #334155;
      }

      .edit-modal-body {
        padding: 30px;
        background: white;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .form-row:last-child {
        margin-bottom: 0;
      }

      .form-group {
        position: relative;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #374151;
        font-size: 14px;
      }

      .required {
        color: #ef4444;
        font-weight: 600;
      }

      .max-info {
        display: block;
        margin-top: 4px;
        color: #6b7280;
        font-size: 12px;
        font-weight: 400;
      }

      .form-group input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        transition: all 0.2s ease;
        box-sizing: border-box;
      }

      .form-group input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .edit-modal-footer {
        background: #f8fafc;
        padding: 20px 30px;
        border-top: 1px solid #e2e8f0;
      }

      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .btn-cancel {
        padding: 12px 24px;
        border: 2px solid #d1d5db;
        background: white;
        color: #6b7280;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 100px;
        justify-content: center;
      }

      .btn-cancel:hover {
        background: #f9fafb;
        border-color: #9ca3af;
        color: #374151;
      }

      .btn-save {
        padding: 12px 24px;
        border: none;
        background: #3b82f6;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        min-width: 100px;
        justify-content: center;
      }

      .btn-save:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .edit-modal {
          padding: 15px;
        }

        .edit-modal-content {
          max-width: 100%;
        }

        .edit-modal-header {
          padding: 20px;
        }

        .edit-modal-body {
          padding: 20px;
        }

        .edit-modal-footer {
          padding: 20px;
        }

        .form-row {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .form-actions {
          flex-direction: column;
        }

        .btn-cancel,
        .btn-save {
          width: 100%;
        }
      }

      .btn-add {
        padding: 8px 16px;
        border: none;
        background: #27ae60;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 10px;
      }

      .btn-add:hover {
        background: #229954;
      }

      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        margin-top: 15px;
      }

      .gallery-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
      }

      .gallery-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
      }

      .btn-delete {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(231, 76, 60, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
        z-index: 10;
      }

      .btn-delete:hover {
        background: #e74c3c;
        transform: scale(1.1);
      }

      /* Gallery item styling */
      .gallery-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.2s ease;
        border: 2px solid transparent;
        width: 100%;
        height: 120px;
      }

      .gallery-item:hover {
        border-color: #3498db;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .gallery-item img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        display: block;
      }

      /* Gallery grid styling */
      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 15px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        background: #f9f9f9;
      }

      .gallery-grid:hover {
        border-color: #3498db;
        background: #f0f8ff;
      }

      /* File input container styling */
      .file-input-container {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #f9f9f9;
        transition: all 0.3s ease;
      }

      .file-input-container:hover {
        border-color: #3498db;
        background: #f0f8ff;
      }

      .btn-pilih-file {
        padding: 8px 16px;
        border: none;
        background: #3b82f6;
        color: white;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      .btn-pilih-file:hover {
        background: #2563eb;
        transform: translateY(-1px);
      }

      .file-text {
        color: #666;
        font-size: 14px;
        flex: 1;
      }

      /* Preview section styling */
      .preview-section {
        margin: 20px 0;
        padding: 15px;
        border: 2px solid #e8f4fd;
        border-radius: 8px;
        background: #f8fbff;
      }

      .preview-section h4 {
        color: #2c5aa0;
        margin-bottom: 15px;
        font-size: 16px;
        font-weight: 600;
      }

      /* File input styling like thumbnail */
      input[type="file"] {
        width: 100%;
        padding: 12px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        background: #f9f9f9;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
      }

      input[type="file"]:hover {
        border-color: #3498db;
        background: #f0f8ff;
      }

      input[type="file"]:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }

      /* Modal styling consistency */
      .edit-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .edit-modal-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
      }

      .edit-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
        border-radius: 12px 12px 0 0;
      }

      .edit-modal-header h3 {
        margin: 0;
        color: #2c3e50;
        font-size: 1.5rem;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #666;
        padding: 5px;
        border-radius: 4px;
        transition: all 0.2s ease;
      }

      .close-btn:hover {
        background: #f0f0f0;
        color: #333;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
      }

      .current-gallery h4 {
        margin: 20px 0 15px 0;
        color: #2c3e50;
        font-size: 1.1rem;
      }

      .content__item-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        margin-top: 0;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.4s ease-in-out;
      }

      .content__item-title.fade-out {
        opacity: 0 !important;
        transform: translateY(-20px) !important;
      }

      .content__item-title.fade-in {
        opacity: 1 !important;
        transform: translateY(0) !important;
      }

      /* Pastikan elemen yang aktif terlihat */
      .content__item--current .content__item-title {
        opacity: 1 !important;
        transform: translateY(0) !important;
      }

      .content__item--current .content__image {
        opacity: 1 !important;
        transform: scale(1) !important;
      }

      .content__item--current .content__meta {
        opacity: 1 !important;
        transform: translateY(0) !important;
      }

      /* Elemen yang tidak aktif tersembunyi */
      .content__item:not(.content__item--current) .content__item-title {
        opacity: 0 !important;
        transform: translateY(20px) !important;
      }

      .content__item:not(.content__item--current) .content__image {
        opacity: 0 !important;
        transform: scale(0.95) !important;
      }

      .content__item:not(.content__item--current) .content__meta {
        opacity: 0 !important;
        transform: translateY(20px) !important;
      }

      .content__meta {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.4s ease-in-out;
      }

      .content__meta.fade-out {
        opacity: 0 !important;
        transform: translateY(-20px) !important;
      }

      .content__meta.fade-in {
        opacity: 1 !important;
        transform: translateY(0) !important;
      }

      .content__meta-item {
        padding: 0.25rem 0;
        border-bottom: 1px solid #ecf0f1;
      }

      .content__meta-item:last-child {
        border-bottom: none;
      }

      .content__meta-item strong {
        color: #34495e;
        font-weight: 600;
        min-width: 120px;
        display: inline-block;
      }

      /* Override untuk mengurangi padding content__item-details */
      .content__item-details {
        padding: 0.25em 0 !important;
        text-align: center !important;
        max-width: 800px;
        margin: 0 auto;
      }

      /* Responsive untuk room detail */
      @media (max-width: 768px) {
        .content__layout {
          flex-direction: column;
          gap: 1.5rem;
          padding: 0 0.25rem;
          justify-content: center;
          max-width: 100%;
          margin: 0 auto;
        }

        .content__info {
          padding-left: 0.25rem;
        }

        .content__image {
          width: 100%;
          height: 150px;
          order: -1;
          max-width: 250px;
          margin: 0 auto;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .content__item-title {
          font-size: 1.3rem;
        }

        .content__item-details {
          max-width: 100%;
          padding: 0.25em 0.5rem !important;
        }
      }

      /* Upload Progress Styles */
      .upload-progress-container {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      .upload-progress-container h4 {
        margin: 0 0 15px 0;
        color: #495057;
        font-size: 14px;
        font-weight: 600;
      }

      .upload-progress-item {
        margin-bottom: 10px;
        padding: 10px;
        background: white;
        border-radius: 6px;
        border: 1px solid #dee2e6;
      }

      .progress-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .filename {
        font-size: 13px;
        color: #495057;
        font-weight: 500;
        flex: 1;
        margin-right: 10px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .status {
        font-size: 12px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 12px;
        background: #e9ecef;
        color: #6c757d;
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        width: 0%;
        background: #007bff;
        transition: width 0.3s ease, background-color 0.3s ease;
        border-radius: 3px;
      }

      .btn-save:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-save .fa-spinner {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Additional button styles */
      .btn-add-more {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        margin-right: 10px;
      }

      .btn-add-more:hover {
        background: #218838;
        transform: translateY(-1px);
      }

      .btn-done {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .btn-done:hover {
        background: #138496;
        transform: translateY(-1px);
      }

      /* Gallery loading styles */
      .gallery-loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
      }

      .gallery-loading i {
        font-size: 24px;
        margin-bottom: 10px;
        color: #007bff;
      }

      .gallery-loading p {
        margin: 0;
        font-size: 14px;
      }

      /* Delete button loading styles */
      .btn-delete:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }

      .btn-delete .fa-spinner {
        animation: spin 1s linear infinite;
      }

      /* Delete room button styles */
      .btn-delete-room {
        background: #dc3545 !important;
        color: white !important;
        border: none !important;
        padding: 10px 20px !important;
        border-radius: 6px !important;
        cursor: pointer !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        transition: all 0.3s ease !important;
        margin-right: 10px !important;
        display: inline-block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }

      .btn-delete-room:hover {
        background: #c82333 !important;
        transform: translateY(-1px) !important;
      }

      .btn-delete-room:disabled {
        opacity: 0.6 !important;
        cursor: not-allowed !important;
      }

      /* Ensure form actions display properly */
      .form-actions {
        display: flex !important;
        gap: 10px !important;
        align-items: center !important;
        justify-content: flex-end !important;
      }

      /* Force delete button to be visible */
      #editRoomModal .btn-delete-room {
        display: inline-block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: static !important;
        width: auto !important;
        height: auto !important;
        min-width: 120px !important;
        z-index: 1000 !important;
        pointer-events: auto !important;
      }

      /* Room action buttons container */
      .room-action-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      /* Delete room button in list */
      .delete-room-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        height: 32px;
      }

      .delete-room-btn:hover {
        background: #c82333;
        transform: translateY(-1px);
      }

      .delete-room-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .delete-room-btn .fa-spinner {
        animation: spin 1s linear infinite;
      }
    </style>
    <script src="js/modernizr-custom.js"></script>
    <!-- Fancybox JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
  </head>
  <body class="buildingdetail">
    <!-- Custom Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Custom Confirmation Modal -->
    <div class="confirmation-modal" id="confirmationModal">
      <div class="confirmation-content">
        <div class="confirmation-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="confirmation-title" id="confirmationTitle">Konfirmasi</div>
        <div class="confirmation-message" id="confirmationMessage">
          Apakah Anda yakin?
        </div>
        <div class="confirmation-actions">
          <button class="btn-confirm cancel" onclick="hideConfirmation()">
            Batal
          </button>
          <button class="btn-confirm confirm" id="confirmButton">
            Ya, Lanjutkan
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="buildingdetails-main">
        <header class="detail-header">
          <a
            class="detail-icon detail-icon--prev"
            href="#"
            title="Kembali"
            onclick="window.parent.postMessage('close-buildingdetail', '*'); return false;"
          >
            <i class="fas fa-arrow-left"></i>
            <span style="margin-left: 0.5em; vertical-align: middle"
              >Kembali</span
            >
          </a>
          <h1 id="building-title">Detail Bangunan</h1>
        </header>

        <div class="building">
          <div class="levels" id="levels-container">
            <!-- Levels akan di-generate secara dinamis -->
            <div class="loading">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Memuat data bangunan...</p>
            </div>
          </div>
        </div>

        <button
          class="boxbutton boxbutton--dark open-search"
          aria-label="Show search"
        >
          <i class="fas fa-search"></i>
        </button>

        <nav class="buildingnav buildingnav--hidden">
          <button class="boxbutton buildingnav__button--up" aria-label="Go up">
            <i class="fas fa-angle-up"></i>
          </button>
          <button
            class="boxbutton boxbutton--dark buildingnav__button--all-levels"
            aria-label="Back to all levels"
          >
            <i class="fas fa-layer-group"></i>
          </button>
          <button
            class="boxbutton buildingnav__button--down"
            aria-label="Go down"
          >
            <i class="fas fa-angle-down"></i>
          </button>
          <button
            class="boxbutton buildingnav__button--view-toggle"
            aria-label="Toggle 2D/2.5D view"
            id="view-toggle-btn"
            title="Toggle 2D/2.5D view"
          >
            <span id="view-toggle-text">2.5D</span>
          </button>
        </nav>

        <div class="buildingdetails-content" id="content-area"></div>
      </div>

      <aside class="spaces-list" id="spaces-list">
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Memuat daftar ruangan...</p>
        </div>
      </aside>
    </div>

    <script>
      // Konfigurasi API
      const API_BASE_URL = "https://pointmap-production.up.railway.app/api";

      // Helper function untuk memastikan URL gambar benar
      function getImageUrl(pathFile) {
        if (!pathFile) return "";

        // Debug: log path asli
        console.log("Original path:", pathFile);

        // Jika sudah URL lengkap (http/https), gunakan langsung
        if (pathFile.startsWith("http://") || pathFile.startsWith("https://")) {
          console.log("Using full URL:", pathFile);
          return pathFile;
        }

        // Jika path relatif, tambahkan ../
        if (pathFile.startsWith("./") || pathFile.startsWith("../")) {
          console.log("Using relative path:", pathFile);
          return pathFile;
        }

        // Jika path tanpa prefix, tambahkan ../
        const finalPath = `../${pathFile}`;
        console.log("Using prefixed path:", finalPath);
        return finalPath;
      }

      // Fungsi untuk memperbarui data gallery global dan re-render bangunan
      async function refreshGlobalGalleryData(buildingId) {
        try {
          console.log(
            "Refreshing global gallery data for building:",
            buildingId
          );

          // Fetch data gallery terbaru untuk semua ruangan di bangunan ini
          const response = await fetch(`${API_BASE_URL}/ruangan-gallery`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
          });

          if (response.ok) {
            const newGalleryData = await response.json();
            console.log("New gallery data received:", newGalleryData);

            // Update data global
            window.ruanganGalleryData = newGalleryData;
            console.log(
              "Updated window.ruanganGalleryData:",
              window.ruanganGalleryData
            );

            // Re-render bangunan dengan data gallery terbaru
            if (window.ruanganData && window.buildingData) {
              console.log("Re-rendering building with updated gallery data");
              console.log("Using buildingData:", window.buildingData);
              console.log("Using ruanganData:", window.ruanganData);
              console.log("Using newGalleryData:", newGalleryData);

              renderBuilding(
                window.buildingData,
                window.ruanganData,
                window.lantaiGambarData || {},
                newGalleryData
              );

              console.log("Building re-rendered successfully");
            } else {
              console.error("Missing data for re-render:");
              console.error("window.ruanganData:", window.ruanganData);
              console.error("window.buildingData:", window.buildingData);
            }

            return true;
          } else {
            console.error("Failed to refresh gallery data:", response.status);
            return false;
          }
        } catch (error) {
          console.error("Error refreshing gallery data:", error);
          return false;
        }
      }

      // Fungsi untuk mendapatkan parameter dari URL
      function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Fungsi untuk mendapatkan data bangunan dan ruangan
      async function loadBuildingData() {
        try {
          const buildingId = getUrlParameter("id") || "1"; // Default ke ID 1
          const buildingName = getUrlParameter("name") || "Bangunan";

          // Ambil data bangunan
          const buildingResponse = await fetch(
            `${API_BASE_URL}/bangunan/${buildingId}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
            }
          );
          if (!buildingResponse.ok) {
            throw new Error(`HTTP error! status: ${buildingResponse.status}`);
          }
          const buildingData = await buildingResponse.json();
          // Simpan data bangunan secara global untuk digunakan di modal edit
          window.buildingData = buildingData;

          // Ambil data ruangan untuk bangunan ini (gunakan endpoint 3D untuk posisi pin dinamis)
          const ruanganResponse = await fetch(
            `${API_BASE_URL}/ruangan/bangunan/${buildingId}/3d`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
            }
          );
          if (!ruanganResponse.ok) {
            throw new Error(`HTTP error! status: ${ruanganResponse.status}`);
          }
          const ruanganData = await ruanganResponse.json();

          // Cek apakah data ruangan kosong atau tidak ada
          if (!ruanganData || Object.keys(ruanganData).length === 0) {
            // Tampilkan modal info alih-alih error
            showInfoModal(buildingData.nama || "Bangunan");
            return;
          }

          // Ambil data lantai gambar untuk bangunan ini
          let lantaiGambarData = [];
          try {
            const lantaiResponse = await fetch(
              `${API_BASE_URL}/lantai-gambar/bangunan/${buildingId}`,
              {
                method: "GET",
                headers: {
                  "Content-Type": "application/json",
                },
                credentials: "include",
              }
            );
            if (lantaiResponse.ok) {
              lantaiGambarData = await lantaiResponse.json();
            } else {
              console.error(
                "Failed to load lantai gambar data:",
                lantaiResponse.status
              );
            }
          } catch (error) {
            console.warn("Error loading lantai gambar data:", error);
          }

          // Ambil data gallery untuk semua ruangan
          let ruanganGalleryData = [];
          try {
            const galleryResponse = await fetch(
              `${API_BASE_URL}/ruangan-gallery`,
              {
                method: "GET",
                headers: {
                  "Content-Type": "application/json",
                },
                credentials: "include",
              }
            );
            if (galleryResponse.ok) {
              ruanganGalleryData = await galleryResponse.json();
              // Buat data tersedia secara global
              window.ruanganGalleryData = ruanganGalleryData;
              window.buildingData = buildingData; // Simpan building data secara global
              window.lantaiGambarData = lantaiGambarData; // Simpan lantai gambar data secara global

              console.log("✅ Data global tersimpan:");
              console.log("window.buildingData:", window.buildingData);
              console.log("window.ruanganData:", window.ruanganData);
              console.log(
                "window.ruanganGalleryData:",
                window.ruanganGalleryData
              );
              console.log("window.lantaiGambarData:", window.lantaiGambarData);
            } else {
              console.error(
                "Failed to load gallery data:",
                galleryResponse.status
              );
            }
          } catch (error) {
            console.warn("Error loading gallery data:", error);
          }

          // Generate CSS dinamis untuk posisi pin
          // Make ruangan data globally available for debug
          window.ruanganData = ruanganData;

          generateDynamicPinCSS(ruanganData);

          // Render bangunan dengan data tambahan
          renderBuilding(
            buildingData,
            ruanganData,
            lantaiGambarData,
            ruanganGalleryData
          );
        } catch (error) {
          console.error("Error loading building data:", error);

          // Redirect ke halaman error dengan parameter yang diperlukan
          const buildingId = getUrlParameter("id") || "1";
          let buildingName = getUrlParameter("name") || "Bangunan";

          // Jika error terjadi setelah data bangunan berhasil diambil, gunakan nama dari API
          if (error.message.includes("Data ruangan tidak ditemukan")) {
            // Gunakan fetch tanpa await karena di dalam catch block
            fetch(`${API_BASE_URL}/bangunan/${buildingId}`, {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
            })
              .then((response) => {
                if (response.ok) {
                  return response.json();
                }
                throw new Error("Failed to fetch building data");
              })
              .then((buildingData) => {
                buildingName = buildingData.nama || buildingName;
                showInfoModal(buildingName);
              })
              .catch((fetchError) => {
                console.error("Error fetching building name:", fetchError);
                showInfoModal(buildingName);
              });
            return; // Keluar dari catch block
          }

          const errorUrl = `error.html?id=${buildingId}&name=${encodeURIComponent(
            buildingName
          )}&error=${encodeURIComponent(error.message)}`;

          window.location.href = errorUrl;
        }
      }

      // New Dynamic Pin CSS Generator
      function generateDynamicPinCSS(ruanganData) {
        let cssRules = "";

        // Iterate melalui semua lantai
        Object.keys(ruanganData).forEach((lantai) => {
          const ruanganLantai = ruanganData[lantai];

          ruanganLantai.forEach((ruangan, index) => {
            const pinClass = ruangan.pin_class;
            let top, left;

            // Calculate pin size in percentage (4vmin width, 6vmin height)
            const pinWidthPercent = 4; // 4vmin = 4% of viewport
            const pinHeightPercent = 6; // 6vmin = 6% of viewport

            // Debug: Log raw data from database

            // Gunakan posisi dinamis jika tersedia, jika tidak gunakan fallback
            if (ruangan.pin_position.top && ruangan.pin_position.left) {
              top = ruangan.pin_position.top;
              left = ruangan.pin_position.left;
            } else {
              // Gunakan fallback position dengan pin size consideration
              const fallbackTop = Math.max(
                pinHeightPercent / 2,
                Math.min(
                  ruangan.fallback_position.top,
                  100 - pinHeightPercent / 2
                )
              );
              const fallbackLeft = Math.max(
                pinWidthPercent / 2,
                Math.min(
                  ruangan.fallback_position.left,
                  100 - pinWidthPercent / 2
                )
              );
              top = `${fallbackTop}vmin`;
              left = `${fallbackLeft}vmin`;
            }

            // Parse coordinates - now backend sends percentage values
            let topPercent, leftPercent;

            // Extract percentage values
            if (typeof top === "string" && top.includes("%")) {
              topPercent = parseFloat(top);
            } else {
              topPercent = parseFloat(top);
            }

            if (typeof left === "string" && left.includes("%")) {
              leftPercent = parseFloat(left);
            } else {
              leftPercent = parseFloat(left);
            }

            // Validate coordinates
            if (isNaN(topPercent) || isNaN(leftPercent)) {
              console.error(
                `Invalid coordinates for ${pinClass}: top="${top}", left="${left}" -> topPercent=${topPercent}, leftPercent=${leftPercent}`
              );
              return;
            }

            // Use exact coordinates with adjustment based on actual SVG dimensions
            // This ensures pin markers align with the actual SVG image, not the container
            let finalTop, finalLeft;

            // Get actual SVG dimensions and positioning within the level container
            const levelElement = document.querySelector(`.level--${lantai}`);
            let svgImage = null;
            let svgRect = null;
            let levelRect = null;

            if (levelElement) {
              svgImage = levelElement.querySelector("img");
              if (svgImage) {
                // Get the actual displayed dimensions of both level container and SVG image
                levelRect = levelElement.getBoundingClientRect();
                svgRect = svgImage.getBoundingClientRect();
              }
            }

            // Calculate coordinates based on actual SVG content area (excluding transparent padding)
            if (svgRect && levelRect) {
              // Get the actual SVG content dimensions (excluding transparent padding)
              const svgContentWidth = svgImage.naturalWidth || svgRect.width;
              const svgContentHeight = svgImage.naturalHeight || svgRect.height;

              // Calculate the actual content area within the displayed SVG
              const contentAspectRatio = svgContentWidth / svgContentHeight;
              const displayAspectRatio = svgRect.width / svgRect.height;

              let actualContentWidth, actualContentHeight;
              let contentOffsetX = 0,
                contentOffsetY = 0;

              if (contentAspectRatio > displayAspectRatio) {
                // Content is wider than display - fit to width
                actualContentWidth = svgRect.width;
                actualContentHeight = svgRect.width / contentAspectRatio;
                contentOffsetY = (svgRect.height - actualContentHeight) / 2;
              } else {
                // Content is taller than display - fit to height
                actualContentHeight = svgRect.height;
                actualContentWidth = svgRect.height * contentAspectRatio;
                contentOffsetX = (svgRect.width - actualContentWidth) / 2;
              }

              // Calculate coordinates relative to actual content area
              const contentLeftPercent =
                (leftPercent * actualContentWidth) / svgRect.width +
                (contentOffsetX / svgRect.width) * 100;
              const contentTopPercent =
                (topPercent * actualContentHeight) / svgRect.height +
                (contentOffsetY / svgRect.height) * 100;

              finalTop = Math.max(0, contentTopPercent - 5);
              finalLeft = Math.max(0, contentLeftPercent - 5);
            } else {
              // Fallback to direct coordinates if SVG info not available
              finalTop = Math.max(0, topPercent - 5);
              finalLeft = Math.max(0, leftPercent - 5);
            }

            // Store the coordinates for debug indicators to use
            if (!window.pinCoordinates) window.pinCoordinates = {};
            window.pinCoordinates[pinClass] = {
              top: `${finalTop}%`,
              left: `${finalLeft}%`,
              ruangan: ruangan.nama_ruangan,
              original: { top: `${topPercent}%`, left: `${leftPercent}%` },
              adjusted: { top: `${finalTop}%`, left: `${finalLeft}%` },
              shift: { top: -5, left: -5 }, // Shift values applied
            };

            // Generate CSS with exact percentage positioning
            const cssRule = `
              .${pinClass} {
                top: ${finalTop}% !important;
                left: ${finalLeft}% !important;
                position: absolute !important;
                z-index: 10 !important;
                transform-origin: 50% 100% !important;
                -webkit-transform-origin: 50% 100% !important;
              }
            `;

            cssRules += cssRule;
          });
        });

        // Apply CSS
        if (cssRules) {
          const styleElement = document.createElement("style");
          styleElement.id = "dynamic-pin-css";
          styleElement.textContent = cssRules;

          // Remove existing style if any
          const existingStyle = document.getElementById("dynamic-pin-css");
          if (existingStyle) {
            existingStyle.remove();
          }

          // Add to head
          document.head.appendChild(styleElement);
        }
      }

      // Setup debug area dengan grid dan corner markers

      // Get SVG dimensions for a specific level
      function getSVGDimensions(levelId) {
        const levelElement = document.querySelector(`.level--${levelId}`);
        if (levelElement) {
          const svgImage = levelElement.querySelector("img");
          if (svgImage) {
            // Get the actual displayed dimensions
            const rect = svgImage.getBoundingClientRect();
            return {
              width: rect.width,
              height: rect.height,
              aspectRatio: rect.width / rect.height,
            };
          }
        }
        return null;
      }

      // Fungsi untuk render bangunan
      function renderBuilding(
        buildingData,
        ruanganData,
        lantaiGambarData,
        ruanganGalleryData
      ) {
        const levelsContainer = document.getElementById("levels-container");
        const contentArea = document.getElementById("content-area");
        const spacesList = document.getElementById("spaces-list");

        // Update judul bangunan
        document.getElementById("building-title").textContent =
          buildingData.nama || "Detail Bangunan";

        // Render levels
        let levelsHTML = "";
        let contentItems = [];
        let spacesListData = [];

        // Dapatkan semua lantai yang ada dari data ruangan
        const allLevels = Object.keys(ruanganData)
          .map(Number)
          .sort((a, b) => a - b);

        allLevels.forEach((lantai) => {
          const ruanganLantai = ruanganData[lantai] || [];

          // Cari data lantai dari API
          const lantaiData = lantaiGambarData.find(
            (item) => item.nama_file === `Lt${lantai}.svg`
          );

          // Tentukan path SVG berdasarkan data dari API atau fallback
          let svgPath = "";
          let fallbackPath = `../img/default/lantai/Lt${lantai}.svg`;

          if (lantaiData && lantaiData.path_file) {
            svgPath = `${lantaiData.path_file.startsWith("http") ? "" : "../"}${
              lantaiData.path_file
            }`;
          } else if (buildingData.id_bangunan) {
            svgPath = `../img/${buildingData.id_bangunan}/lantai/Lt${lantai}.svg`;
          } else {
            // Fallback untuk bangunan lain
            svgPath = `../img/default/lantai/Lt${lantai}.svg`;
            fallbackPath = `../img/default/lantai/default.svg`;
          }

          // Tambahkan level HTML
          levelsHTML += `
            <div class="level level--${lantai}" aria-label="Lantai ${lantai}">
              <img
                class="map map--${lantai}"
                src="${svgPath}"
                alt="Map Lantai ${lantai}"
                width="100%"
                height="100%"
                style="display: block"
                onerror="this.src='${fallbackPath}'"
              />
              <div class="level__pins" id="level${lantai}-pins">
              </div>
            </div>
          `;

          // Tambahkan data pin dan konten untuk setiap ruangan
          ruanganLantai.forEach((ruangan, ruanganIndex) => {
            const spaceId = `${lantai}.${String(ruanganIndex + 1).padStart(
              2,
              "0"
            )}`;

            // Data untuk konten
            contentItems.push({
              space: spaceId,
              title: ruangan.nama_ruangan,
              jurusan: ruangan.nama_jurusan || "Tidak ada jurusan",
              prodi: ruangan.nama_prodi || "Tidak ada prodi",
              ruangan: ruangan,
            });

            // Data untuk spaces list
            spacesListData.push({
              level: parseInt(lantai),
              space: spaceId,
              name: ruangan.nama_ruangan,
            });
          });
        });

        // Render levels
        levelsContainer.innerHTML = levelsHTML;

        // Render pins untuk setiap level
        allLevels.forEach((lantai) => {
          const ruanganLantai = ruanganData[lantai] || [];
          const pinsContainer = document.getElementById(`level${lantai}-pins`);

          ruanganLantai.forEach((ruangan, ruanganIndex) => {
            const spaceId = `${lantai}.${String(ruanganIndex + 1).padStart(
              2,
              "0"
            )}`;

            const pinElement = document.createElement("a");
            pinElement.className = `pin pin--${lantai}-${ruanganIndex + 1}`;
            pinElement.setAttribute("data-space", spaceId);
            pinElement.setAttribute(
              "data-pin-style",
              ruangan.pin_style || "default"
            );
            pinElement.setAttribute("href", "#");
            pinElement.setAttribute(
              "aria-label",
              `Pin untuk ${ruangan.nama_ruangan}`
            );
            pinElement.style.cursor = "pointer"; // Ensure cursor shows it's clickable

            // Pin click event will be handled by initializePinMarkers() function

            const span = document.createElement("span");
            span.className = "pin__icon";

            const icon = document.createElement("i");
            icon.className = "fas fa-map-marker-alt";
            span.appendChild(icon);

            pinElement.appendChild(span);
            pinsContainer.appendChild(pinElement);
          });
        });

        // Render konten
        renderContent(
          contentItems,
          buildingData.nama,
          ruanganGalleryData,
          buildingData
        );

        // Render spaces list
        renderSpacesList(spacesListData, allLevels);

        // Re-initialize main.js functionality after dynamic content is loaded
        setTimeout(() => {
          if (typeof window.buildingDetailsInit === "function") {
            window.buildingDetailsInit();
          }

          // Pin markers will be initialized by initializePinMarkers() function

          // Initialize Fancybox for gallery
          Fancybox.bind("[data-fancybox]", {
            loop: true,
            buttons: ["zoom", "slideShow", "fullScreen", "thumbs", "close"],
            animationEffect: "fade",
            transitionEffect: "slide",
            thumbs: {
              autoStart: false,
            },
            on: {
              initLayout: (fancybox) => {
                // Fancybox initialized
              },
            },
          });

          // Update gallery count dynamically
          updateGalleryCounts();

          // Initialize pin markers with original main.js approach
          // Add longer delay to ensure all elements are created
          setTimeout(() => {
            initializePinMarkers();
          }, 200);
        }, 100);
      }

      // Fungsi untuk membuat HTML konten
      function renderContent(
        items,
        buildingName,
        ruanganGalleryData,
        buildingData
      ) {
        const contentArea = document.getElementById("content-area");

        const contentHTML = items
          .map((item) => {
            return `
              <div class="content__item" data-space="${item.space}">
                <div class="content__item-details">
                  <div class="content__layout">
                    <div class="content__info">
                      <div class="content__header">
                        <h3 class="content__item-title">${item.title}</h3>
                        ${
                          localStorage.getItem("token")
                            ? `
                          <div class="room-action-buttons">
                            <button 
                              onclick="openEditRoomModal('${
                                item.ruangan.id_ruangan
                              }', '${item.title}', ${
                                item.ruangan.nomor_lantai
                              }, '${item.jurusan || ""}', '${
                                item.prodi || ""
                              }')"
                              class="edit-room-btn"
                              title="Edit ruangan"
                            >
                              <i class="fas fa-edit"></i>
                            </button>

                          </div>
                        `
                            : ""
                        }
                      </div>
                      <div class="content__meta">
                        <div class="content__meta-item">
                          <strong>Bangunan:</strong> ${buildingName}
                        </div>
                        <div class="content__meta-item">
                          <strong>Lantai:</strong> ${item.ruangan.nomor_lantai}
                        </div>
                        <div class="content__meta-item">
                          <strong>Jurusan:</strong> ${item.jurusan}
                        </div>
                        <div class="content__meta-item">
                          <strong>Program Studi:</strong> ${item.prodi}
                        </div>
                      </div>
                    </div>
                    <div class="content__image">
                      <div class="room-gallery">
                        ${
                          localStorage.getItem("token")
                            ? `
                          <button 
                            onclick="openEditGalleryModal('${item.ruangan.id_ruangan}', '${item.title}')"
                            class="edit-gallery-btn"
                            title="Edit gallery"
                          >
                            <i class="fas fa-edit"></i>
                          </button>
                        `
                            : ""
                        }
                        ${(() => {
                          // Cari data gallery untuk ruangan ini
                          const ruanganGallery = ruanganGalleryData.filter(
                            (gallery) =>
                              gallery.ruangan &&
                              gallery.ruangan.nama_ruangan === item.title
                          );

                          if (ruanganGallery.length > 0) {
                            // Gunakan data dari API
                            const firstImage = ruanganGallery[0];
                            const imageCount = ruanganGallery.length;

                            return `
                              <div class="gallery-container">
                                ${
                                  localStorage.getItem("token")
                                    ? `
                                  <button 
                                    onclick="openEditGalleryModal('${item.ruangan.id_ruangan}', '${item.title}')"
                                    class="edit-gallery-btn"
                                    title="Edit gallery"
                                  >
                                    <i class="fas fa-edit"></i>
                                  </button>
                                `
                                    : ""
                                }
                                <a href="${
                                  firstImage.path_file.startsWith("http")
                                    ? ""
                                    : "../"
                                }${firstImage.path_file}" 
                                   data-fancybox="gallery-${item.space}"
                                   data-caption="${item.title} - Foto 1"
                                   class="gallery-link">
                                  <img 
                                    src="${getImageUrl(firstImage.path_file)}" 
                                    alt="${item.title}"
                                    class="room-thumbnail"
                                    onError="this.src='../img/default/ruangan/thumbnail.jpg'"
                                  />
                                  <div class="gallery-overlay">
                                    <div class="gallery-indicator">
                                      <i class="fas fa-images"></i>
                                      <span class="gallery-count" data-room="${
                                        item.title
                                      }" data-building="${buildingName}">${imageCount}</span>
                                    </div>
                                  </div>
                                </a>
                              </div>
                              ${ruanganGallery
                                .slice(1)
                                .map(
                                  (gallery, index) => `
                                <a href="${getImageUrl(gallery.path_file)}" 
                                   data-fancybox="gallery-${item.space}"
                                   data-caption="${item.title} - Foto ${
                                    index + 2
                                  }"
                                   style="display: none;">
                                </a>
                              `
                                )
                                .join("")}
                            `;
                          } else {
                            // Fallback ke path berdasarkan ID ruangan
                            return `
                              <div class="gallery-container">
                                ${
                                  localStorage.getItem("token")
                                    ? `
                                  <button 
                                    onclick="openEditGalleryModal('${item.ruangan.id_ruangan}', '${item.title}')"
                                    class="edit-gallery-btn"
                                    title="Edit gallery"
                                  >
                                    <i class="fas fa-edit"></i>
                                  </button>
                                `
                                    : ""
                                }
                                <a href="../img/${
                                  buildingData.id_bangunan
                                }/ruangan/${
                              item.ruangan.id_ruangan
                            }/gallery1.jpg" 
                                   data-fancybox="gallery-${item.space}"
                                   data-caption="${item.title} - Foto 1"
                                   class="gallery-link">
                                  <img 
                                    src="../img/${
                                      buildingData.id_bangunan
                                    }/ruangan/${
                              item.ruangan.id_ruangan
                            }/gallery1.jpg" 
                                    alt="${item.title}"
                                    class="room-thumbnail"
                                    onError="this.src='../img/default/ruangan/thumbnail.jpg'"
                                  />
                                  <div class="gallery-overlay">
                                    <div class="gallery-indicator">
                                      <i class="fas fa-images"></i>
                                      <span class="gallery-count" data-room="${
                                        item.title
                                      }" data-building="${buildingName}">3</span>
                                    </div>
                                  </div>
                                </a>
                              </div>
                            `;
                          }
                        })()}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");

        contentArea.innerHTML = contentHTML;

        // Tambahkan tombol close
        const closeButton = document.createElement("button");
        closeButton.setAttribute(
          "class",
          "boxbutton boxbutton--dark content__button content__button--hidden"
        );
        closeButton.setAttribute("aria-label", "Close details");
        closeButton.innerHTML = '<i class="fas fa-times"></i>';
        contentArea.appendChild(closeButton);
      }

      // Fungsi untuk membuat HTML aside spaces-list
      function renderSpacesList(spacesListData, levels) {
        const spacesList = document.getElementById("spaces-list");

        let html = `
            <div class="search">
            <input class="search__input" placeholder="Cari ruangan..." />
            <button class="boxbutton boxbutton--darker close-search" aria-label="Close details">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <ul class="buildingdetails-list grouped-by-level">
          `;

        levels.forEach((level) => {
          const items = spacesListData.filter(
            (item) => item.level === parseInt(level)
          );
          if (items.length > 0) {
            html += `<div class="list__level-title">Lantai ${level}</div>`;
            items.forEach((item) => {
              html += `
                <li class="list__item" data-level="${item.level}" data-space="${item.space}">
                  <a href="#" class="list__link">${item.name}</a>
                </li>
              `;
            });
          }
        });

        html += "</ul>";
        spacesList.innerHTML = html;
      }

      // Fungsi untuk menampilkan modal info
      function showInfoModal(buildingName) {
        // Update judul bangunan
        document.getElementById("building-title").textContent =
          buildingName || "Detail Bangunan";

        // Sembunyikan seluruh container buildingdetails-main
        const buildingDetailsMain = document.querySelector(
          ".buildingdetails-main"
        );
        if (buildingDetailsMain) {
          buildingDetailsMain.style.display = "none";
        }

        // Buat modal info di luar struktur buildingdetails-main
        const modalHTML = `
          <div class="info-modal" onclick="closeInfoModal()">
            <div class="info-content" onclick="event.stopPropagation()">
              <div class="info-icon">
                <i class="fas fa-info-circle"></i>
              </div>
              <h2 class="info-title">Data Belum Tersedia</h2>
              <p class="info-subtitle">
                Detail ruangan <strong>${buildingName}</strong> sedang dalam pengembangan.
              </p>
              <div class="info-description">
                <p>Informasi lantai dan ruangan bangunan ini akan segera ditambahkan.</p>
                <p>Terima kasih atas pengertiannya.</p>
              </div>
              <div class="info-actions">
                <button class="btn-close" onclick="closeInfoModal()">
                  <i class="fas fa-times"></i>
                  Tutup
                </button>
              </div>
            </div>
          </div>
        `;

        // Tambahkan modal ke body
        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // Tambahkan event listener untuk Escape key
        document.addEventListener("keydown", handleEscapeKey);
      }

      // Fungsi untuk handle Escape key
      function handleEscapeKey(event) {
        if (event.key === "Escape") {
          closeInfoModal();
        }
      }

      // Fungsi untuk menghitung jumlah gambar gallery secara dinamis
      function updateGalleryCounts() {
        const galleryCounts = document.querySelectorAll(".gallery-count");

        galleryCounts.forEach((countElement) => {
          const roomName = countElement.getAttribute("data-room");
          const buildingName = countElement.getAttribute("data-building");

          // Gunakan data dari API jika tersedia, jika tidak gunakan fallback
          if (
            window.ruanganGalleryData &&
            window.ruanganGalleryData.length > 0
          ) {
            const roomGallery = window.ruanganGalleryData.filter(
              (gallery) =>
                gallery.ruangan && gallery.ruangan.nama_ruangan === roomName
            );

            if (roomGallery.length > 0) {
              countElement.textContent = roomGallery.length.toString();
              return;
            }
          }

          // Fallback: Hitung jumlah file gallery yang ada berdasarkan ID
          let imageCount = 0;
          const checkImage = (index) => {
            if (index > 10) {
              countElement.textContent = imageCount || "1";
              return;
            }

            const img = new Image();
            img.onload = function () {
              imageCount++;
              checkImage(index + 1);
            };
            img.onerror = function () {
              countElement.textContent = imageCount || "1";
            };
            // Gunakan path berdasarkan ID ruangan
            const roomId = getRoomIdByName(roomName);
            const buildingId = getBuildingIdByName(buildingName);
            // Gunakan path dari API jika tersedia, fallback ke path lokal
            if (
              window.ruanganGalleryData &&
              window.ruanganGalleryData.length > 0
            ) {
              const roomGallery = window.ruanganGalleryData.find(
                (gallery) =>
                  gallery.ruangan && gallery.ruangan.nama_ruangan === roomName
              );
              if (roomGallery && roomGallery.path_file) {
                img.src = getImageUrl(roomGallery.path_file);
              } else {
                img.src = `../img/${buildingId}/ruangan/${roomId}/gallery${index}.jpg`;
              }
            } else {
              img.src = `../img/${buildingId}/ruangan/${roomId}/gallery${index}.jpg`;
            }
          };

          checkImage(1);
        });
      }

      // Helper function untuk mendapatkan ID ruangan berdasarkan nama
      function getRoomIdByName(roomName) {
        const roomMapping = {
          "Ruang TI-11": 1,
          "Ruang TI-12": 2,
          "Ruang TI-13": 3,
          "Ruang TI-14": 4,
        };
        return roomMapping[roomName] || 2; // Default ke 2 karena yang ada di folder
      }

      // Helper function untuk mendapatkan ID bangunan berdasarkan nama
      function getBuildingIdByName(buildingName) {
        const buildingMapping = {
          "Gedung Lab Teknik Informatika": 27,
        };
        return buildingMapping[buildingName] || 27;
      }

      // Fungsi untuk membuat gallery links secara dinamis
      function createDynamicGalleryLinks() {
        const galleryContainers = document.querySelectorAll(".room-gallery");

        galleryContainers.forEach((container) => {
          const mainLink = container.querySelector(".gallery-link");
          if (!mainLink) return;

          const roomName = mainLink
            .querySelector(".gallery-count")
            .getAttribute("data-room");
          const buildingName = mainLink
            .querySelector(".gallery-count")
            .getAttribute("data-building");
          const spaceId = mainLink
            .getAttribute("data-fancybox")
            .replace("gallery-", "");

          // Hapus semua hidden gallery links yang ada
          const hiddenLinks = container.querySelectorAll(
            'a[style*="display: none"]'
          );
          hiddenLinks.forEach((link) => link.remove());

          // Gunakan data dari API jika tersedia
          if (
            window.ruanganGalleryData &&
            window.ruanganGalleryData.length > 0
          ) {
            const roomGallery = window.ruanganGalleryData.filter(
              (gallery) =>
                gallery.ruangan && gallery.ruangan.nama_ruangan === roomName
            );

            if (roomGallery.length > 1) {
              // Tambahkan gallery links untuk gambar 2 dan seterusnya
              roomGallery.slice(1).forEach((gallery, index) => {
                const link = document.createElement("a");
                link.href = gallery.path_file.startsWith("http")
                  ? gallery.path_file
                  : `../${gallery.path_file}`;
                link.setAttribute("data-fancybox", `gallery-${spaceId}`);
                link.setAttribute(
                  "data-caption",
                  `${roomName} - Foto ${index + 2}`
                );
                link.style.display = "none";
                container.appendChild(link);
              });
              return;
            }
          }

          // Fallback: Cek dan tambahkan hanya gambar yang ada (mulai dari gallery2.jpg)
          for (let i = 2; i <= 10; i++) {
            const img = new Image();
            img.onload = function () {
              // Jika gambar ada, tambahkan link
              const link = document.createElement("a");
              const roomId = getRoomIdByName(roomName);
              const buildingId = getBuildingIdByName(buildingName);
              link.href = `../img/${buildingId}/ruangan/${roomId}/gallery${i}.jpg`;
              link.setAttribute("data-fancybox", `gallery-${spaceId}`);
              link.setAttribute("data-caption", `${roomName} - Foto ${i}`);
              link.style.display = "none";
              container.appendChild(link);
            };
            img.onerror = function () {
              // Jika gambar tidak ada, berhenti
              return;
            };
            const roomId = getRoomIdByName(roomName);
            const buildingId = getBuildingIdByName(buildingName);
            // Gunakan path dari API jika tersedia, fallback ke path lokal
            if (
              window.ruanganGalleryData &&
              window.ruanganGalleryData.length > 0
            ) {
              const roomGallery = window.ruanganGalleryData.find(
                (gallery) =>
                  gallery.ruangan && gallery.ruangan.nama_ruangan === roomName
              );
              if (roomGallery && roomGallery.path_file) {
                img.src = getImageUrl(roomGallery.path_file);
              } else {
                img.src = `../img/${buildingId}/ruangan/${roomId}/gallery${i}.jpg`;
              }
            } else {
              img.src = `../img/${buildingId}/ruangan/${roomId}/gallery${i}.jpg`;
            }
          }
        });
      }

      // Fungsi untuk menutup modal info
      function closeInfoModal() {
        // Hapus event listener
        document.removeEventListener("keydown", handleEscapeKey);

        // Hapus modal dari body
        const modal = document.querySelector(".info-modal");
        if (modal) {
          modal.remove();
        }

        // Tampilkan kembali container buildingdetails-main
        const buildingDetailsMain = document.querySelector(
          ".buildingdetails-main"
        );
        if (buildingDetailsMain) {
          buildingDetailsMain.style.display = "block";
        }

        if (window.parent && window.parent !== window) {
          window.parent.postMessage("close-buildingdetail", "*");
        } else {
          window.history.back();
        }
      }

      // Initialize pin markers with original main.js approach
      function initializePinMarkers() {
        const pins = document.querySelectorAll(".pin");
        const contentEl = document.getElementById("content-area");

        pins.forEach(function (pin, index) {
          const spaceRef = pin.getAttribute("data-space");
          const contentItem = contentEl.querySelector(
            '.content__item[data-space="' + spaceRef + '"]'
          );

          if (contentItem) {
            // Add hover effects (same as original main.js)
            pin.addEventListener("mouseenter", function () {
              if (!document.querySelector(".building--content-open")) {
                contentItem.classList.add("content__item--hover");
              }
            });

            pin.addEventListener("mouseleave", function () {
              if (!document.querySelector(".building--content-open")) {
                contentItem.classList.remove("content__item--hover");
              }
            });

            // Add click event (same as original main.js)
            pin.addEventListener("click", function (ev) {
              ev.preventDefault();
              ev.stopPropagation();

              // Find and click the corresponding list item (same as original main.js)
              const listItem = document.querySelector(
                'li[data-space="' + spaceRef + '"]'
              );

              if (listItem) {
                const spaceLink = listItem.querySelector(".list__link");

                if (spaceLink) {
                  spaceLink.click();
                } else {
                  listItem.click();
                }
              } else {
                // Alternative: try to find any element with this data-space
                const anyElement = document.querySelector(
                  '[data-space="' + spaceRef + '"]'
                );
                if (anyElement) {
                  anyElement.click();
                }
              }

              // Remove hover class
              contentItem.classList.remove("content__item--hover");
            });
          } else {
            console.warn(`Content item not found for pin ${spaceRef}`);
          }
        });
      }

      // Load data saat halaman dimuat
      document.addEventListener("DOMContentLoaded", function () {
        // Load building data first
        loadBuildingData();
      });

      // Fungsi untuk membuka modal edit ruangan
      function openEditRoomModal(roomId, roomName, floor, jurusan, prodi) {
        // Dapatkan jumlah lantai maksimal dari data bangunan
        const buildingId = getUrlParameter("id") || "1";
        const maxFloor = window.buildingData ? window.buildingData.lantai : 10;

        // Jika bangunan tidak memiliki data lantai atau lantai = 0, gunakan default 10
        const maxFloorValue = maxFloor > 0 ? maxFloor : 10;
        const modalHTML = `
          <div class="edit-modal" id="editRoomModal">
            <div class="edit-modal-content">
              <div class="edit-modal-header">
                <div class="header-left">
                  <h3>Edit Ruangan</h3>
                  <p>Perbarui informasi ruangan</p>
                </div>
                <button onclick="closeEditRoomModal()" class="close-btn">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              
              <form id="editRoomForm">
                <div class="edit-modal-body">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Nama Ruangan <span class="required">*</span></label>
                      <input type="text" id="editRoomName" value="${roomName}" required>
                    </div>
                    <div class="form-group">
                      <label>Lantai <span class="required">*</span></label>
                      <input type="number" id="editRoomFloor" value="${floor}" min="1" max="${maxFloorValue}" required>
                      <small class="max-info">Maksimal: ${maxFloorValue}</small>
                    </div>
                  </div>
                  
                  <div class="form-row">
                    <div class="form-group">
                      <label>Jurusan</label>
                      <input type="text" id="editRoomJurusan" value="${jurusan}">
                    </div>
                    <div class="form-group">
                      <label>Program Studi</label>
                      <input type="text" id="editRoomProdi" value="${prodi}">
                    </div>
                  </div>
                </div>
                
                <div class="edit-modal-footer">
                  <div class="form-actions">
                    <button type="button" onclick="closeEditRoomModal()" class="btn-cancel">
                      <i class="fas fa-times"></i>
                      Batal
                    </button>
                    <button type="submit" class="btn-save">
                      <i class="fas fa-save"></i>
                      Simpan
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // Check if modal HTML was inserted correctly
        const modal = document.querySelector("#editRoomModal");
        if (modal) {
          // Modal created successfully
        }

        // Handle form submission
        document
          .getElementById("editRoomForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            saveRoomEdit(roomId);
          });

        // Handle close button click
        document
          .querySelector("#editRoomModal .close-btn")
          .addEventListener("click", function () {
            closeEditRoomModal();
          });

        // Handle cancel button click
        document
          .querySelector("#editRoomModal .btn-cancel")
          .addEventListener("click", function () {
            closeEditRoomModal();
          });

        // Handle escape key press
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            closeEditRoomModal();
          }
        });
      }

      // Fungsi untuk membuka modal edit gallery
      function openEditGalleryModal(roomId, roomName) {
        const modalHTML = `
          <div class="edit-modal" id="editGalleryModal">
            <div class="edit-modal-content">
              <div class="edit-modal-header">
                <h3>Tambah Foto Gallery - ${roomName}</h3>
                <button onclick="closeEditGalleryModal()" class="close-btn">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="edit-modal-body">
                <div class="form-group">
                  <label>Pilih File</label>
                  <div class="file-input-container">
                    <button type="button" class="btn-pilih-file" onclick="document.getElementById('addGalleryImage').click()">
                      Pilih File
                    </button>
                    <span class="file-text" id="fileText">Tidak ada file yang dipilih</span>
                  </div>
                  <input type="file" id="addGalleryImage" accept="image/*" multiple style="display: none;">
                </div>
                <div class="preview-section" id="previewSection" style="display: none;">
                  <h4>Preview Gambar yang Dipilih:</h4>
                  <div id="selectedImagesPreview" class="gallery-grid">
                    <!-- Selected images preview will be shown here -->
                  </div>
                </div>
                <div class="current-gallery">
                  <h4>Gambar Saat Ini:</h4>
                  <div id="currentGalleryImages" class="gallery-grid">
                    <!-- Current images will be loaded here -->
                  </div>
                </div>
                <div class="form-actions">
                  <button type="button" class="btn-cancel">Batal</button>
                  <button type="button" onclick="saveGalleryImages(${roomId})" class="btn-save">
                    <i class="fas fa-save"></i>
                    Upload
                  </button>
                  <button type="button" onclick="addMoreFiles()" class="btn-add-more" style="display: none;">
                    <i class="fas fa-plus"></i>
                    Tambah File Lagi
                  </button>
                  <button type="button" onclick="closeEditGalleryModal()" class="btn-done" style="display: none;">
                    <i class="fas fa-check"></i>
                    Selesai
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);
        loadCurrentGalleryImages(roomId);

        // Handle close button click for gallery modal
        document
          .querySelector("#editGalleryModal .close-btn")
          .addEventListener("click", function () {
            closeEditGalleryModal();
          });

        // Handle cancel button click for gallery modal
        document
          .querySelector("#editGalleryModal .btn-cancel")
          .addEventListener("click", function () {
            closeEditGalleryModal();
          });

        // Handle escape key press for gallery modal
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            closeEditGalleryModal();
          }
        });

        // Handle file selection and update text
        document
          .getElementById("addGalleryImage")
          .addEventListener("change", function (e) {
            const fileText = document.getElementById("fileText");
            const previewSection = document.getElementById("previewSection");
            const selectedImagesPreview = document.getElementById(
              "selectedImagesPreview"
            );

            if (e.target.files.length > 0) {
              if (e.target.files.length === 1) {
                fileText.textContent = e.target.files[0].name;
              } else {
                fileText.textContent = `${e.target.files.length} file dipilih`;
              }

              // Show preview section and display image previews
              previewSection.style.display = "block";
              selectedImagesPreview.innerHTML = "";

              Array.from(e.target.files).forEach((file, index) => {
                if (file.type.startsWith("image/")) {
                  const reader = new FileReader();
                  reader.onload = function (e) {
                    const previewDiv = document.createElement("div");
                    previewDiv.className = "gallery-item";
                    previewDiv.innerHTML = `
                      <img src="${e.target.result}" alt="Preview ${file.name}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 6px;">
                      <div class="image-info" style="font-size: 12px; color: #666; margin-top: 5px; text-align: center;">
                        ${file.name}
                      </div>
                    `;
                    selectedImagesPreview.appendChild(previewDiv);
                  };
                  reader.readAsDataURL(file);
                }
              });
            } else {
              fileText.textContent = "Tidak ada file yang dipilih";
              previewSection.style.display = "none";
            }
          });
      }

      // Fungsi untuk menutup modal edit ruangan
      function closeEditRoomModal() {
        const modal = document.getElementById("editRoomModal");
        if (modal) {
          modal.remove();
        }
      }

      // Fungsi untuk menutup modal edit gallery
      function closeEditGalleryModal() {
        const modal = document.getElementById("editGalleryModal");
        if (modal) {
          modal.remove();
        }
      }

      // Fungsi untuk menghapus ruangan
      async function deleteRoom(roomId, roomName) {
        showConfirmation(
          "Konfirmasi Hapus Ruangan",
          `Yakin ingin menghapus ruangan "${roomName}"? Tindakan ini tidak dapat dibatalkan.`,
          () => {
            performDeleteRoomWithLoading(roomId);
          }
        );
      }

      // Fungsi untuk menghapus ruangan dengan loading indicator
      async function performDeleteRoomWithLoading(roomId) {
        const deleteButton = document.querySelector(
          "#editRoomModal .btn-delete-room"
        );
        const originalButtonHTML = deleteButton.innerHTML;

        // Disable button and show loading
        deleteButton.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Menghapus...';
        deleteButton.disabled = true;

        try {
          await performDeleteRoom(roomId);
        } finally {
          // Re-enable button (in case of error)
          deleteButton.innerHTML = originalButtonHTML;
          deleteButton.disabled = false;
        }
      }

      // Fungsi untuk menghapus ruangan dari daftar
      async function deleteRoomFromList(roomId, roomName) {
        showConfirmation(
          "Konfirmasi Hapus Ruangan",
          `Yakin ingin menghapus ruangan "${roomName}"? Tindakan ini tidak dapat dibatalkan.`,
          () => {
            performDeleteRoomFromListWithLoading(roomId, roomName);
          }
        );
      }

      // Fungsi untuk menghapus ruangan dari daftar dengan loading indicator
      async function performDeleteRoomFromListWithLoading(roomId, roomName) {
        // Find the delete button for this specific room
        const deleteButton = document.querySelector(
          `[onclick*="deleteRoomFromList('${roomId}"]`
        );
        if (deleteButton) {
          const originalButtonHTML = deleteButton.innerHTML;

          // Disable button and show loading
          deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          deleteButton.disabled = true;

          try {
            await performDeleteRoomFromList(roomId, roomName);
          } finally {
            // Re-enable button (in case of error)
            deleteButton.innerHTML = originalButtonHTML;
            deleteButton.disabled = false;
          }
        } else {
          // Fallback if button not found
          await performDeleteRoomFromList(roomId, roomName);
        }
      }

      // Fungsi untuk melakukan penghapusan ruangan dari daftar
      async function performDeleteRoomFromList(roomId, roomName) {
        try {
          const response = await fetch(`${API_BASE_URL}/ruangan/${roomId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            const result = await response.json();
            const galleryCount = result.deletedGalleryCount || 0;

            showNotification(
              "success",
              "Ruangan Dihapus",
              `Ruangan "${roomName}" berhasil dihapus dari daftar!${
                galleryCount > 0
                  ? ` (${galleryCount} gambar gallery juga dihapus)`
                  : ""
              }`
            );

            // Reload building data to reflect changes
            await loadBuildingData();

            showNotification(
              "success",
              "Data Diperbarui",
              "Daftar ruangan telah diperbarui setelah penghapusan"
            );
          } else {
            throw new Error("Gagal menghapus ruangan");
          }
        } catch (error) {
          console.error("Error:", error);
          showNotification(
            "error",
            "Gagal Dihapus",
            "Gagal menghapus ruangan: " + error.message
          );
        }
      }

      // Fungsi untuk melakukan penghapusan ruangan
      async function performDeleteRoom(roomId) {
        try {
          const response = await fetch(`${API_BASE_URL}/ruangan/${roomId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            const result = await response.json();
            const galleryCount = result.deletedGalleryCount || 0;

            showNotification(
              "success",
              "Ruangan Dihapus",
              `Ruangan berhasil dihapus dari sistem!${
                galleryCount > 0
                  ? ` (${galleryCount} gambar gallery juga dihapus)`
                  : ""
              }`
            );

            // Close modal
            closeEditRoomModal();

            // Reload building data to reflect changes
            await loadBuildingData();

            showNotification(
              "success",
              "Data Diperbarui",
              "Data bangunan telah diperbarui setelah penghapusan"
            );
          } else {
            throw new Error("Gagal menghapus ruangan");
          }
        } catch (error) {
          console.error("Error:", error);
          showNotification(
            "error",
            "Gagal Dihapus",
            "Gagal menghapus ruangan: " + error.message
          );
        }
      }

      // Fungsi untuk menyimpan edit ruangan
      async function saveRoomEdit(roomId) {
        const roomName = document.getElementById("editRoomName").value;
        const floor = document.getElementById("editRoomFloor").value;
        const jurusan = document.getElementById("editRoomJurusan").value;
        const prodi = document.getElementById("editRoomProdi").value;

        // Validasi jumlah lantai
        const maxFloor = window.buildingData ? window.buildingData.lantai : 10;
        const maxFloorValue = maxFloor > 0 ? maxFloor : 10;

        if (parseInt(floor) > maxFloorValue) {
          showNotification(
            "error",
            "Validasi Error",
            `Lantai tidak boleh lebih dari ${maxFloorValue}`
          );
          return;
        }

        try {
          const response = await fetch(`${API_BASE_URL}/ruangan/${roomId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({
              nama_ruangan: roomName,
              nomor_lantai: parseInt(floor),
              nama_jurusan: jurusan,
              nama_prodi: prodi,
            }),
          });

          if (response.ok) {
            showNotification(
              "success",
              "Berhasil diperbarui",
              "Ruangan berhasil diupdate!"
            );
            closeEditRoomModal();
            // Reload data
            loadBuildingData();
          } else {
            throw new Error("Gagal mengupdate ruangan");
          }
        } catch (error) {
          console.error("Error:", error);
          showNotification(
            "error",
            "Gagal diperbarui",
            "Gagal mengupdate ruangan: " + error.message
          );
        }
      }

      // Fungsi untuk memuat gambar gallery saat ini
      async function loadCurrentGalleryImages(roomId) {
        try {
          const container = document.getElementById("currentGalleryImages");

          // Show loading indicator
          container.innerHTML = `
            <div class="gallery-loading">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Memuat gallery...</p>
            </div>
          `;

          const response = await fetch(
            `${API_BASE_URL}/ruangan-gallery/ruangan/${roomId}`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );

          if (response.ok) {
            const galleryData = await response.json();

            // Debug: log data gallery yang diterima
            console.log("Gallery data received:", galleryData);
            console.log("Room ID:", roomId);

            if (galleryData.length > 0) {
              // Debug: log setiap item gallery
              galleryData.forEach((item, index) => {
                console.log(`Gallery item ${index}:`, item);
                console.log(`Path file: ${item.path_file}`);
                console.log(`Final URL: ${getImageUrl(item.path_file)}`);
              });

              container.innerHTML = galleryData
                .map(
                  (item) => `
                <div class="gallery-item" data-gallery-id="${item.id_gallery}">
                  <button onclick="deleteGalleryImageWithLoading(${
                    item.id_gallery
                  }, '${roomId}', this)" class="btn-delete" title="Hapus gambar">
                    <i class="fas fa-trash"></i>
                  </button>
                  <img src="${getImageUrl(item.path_file)}" alt="Gallery">
                </div>
              `
                )
                .join("");
            } else {
              container.innerHTML = "<p>Tidak ada gambar gallery</p>";
            }
          } else {
            container.innerHTML = "<p>Gagal memuat gallery</p>";
          }
        } catch (error) {
          console.error("Error loading gallery:", error);
          const container = document.getElementById("currentGalleryImages");
          container.innerHTML = "<p>Error memuat gallery</p>";
        }
      }

      // Fungsi untuk menyimpan gambar gallery
      async function saveGalleryImages(roomId) {
        const fileInput = document.getElementById("addGalleryImage");
        const files = fileInput.files;

        if (files.length === 0) {
          showNotification(
            "warning",
            "Tidak ada file",
            "Silakan pilih file gambar terlebih dahulu"
          );
          return;
        }

        // Disable save button and show loading
        const saveButton = document.querySelector(
          "#editGalleryModal .btn-save"
        );
        const originalButtonText = saveButton.innerHTML;
        saveButton.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        saveButton.disabled = true;

        // Create progress container
        const progressContainer = document.createElement("div");
        progressContainer.className = "upload-progress-container";
        progressContainer.innerHTML = `
          <h4>Status Upload:</h4>
          <div id="uploadProgressList"></div>
        `;

        const modalBody = document.querySelector(
          "#editGalleryModal .edit-modal-body"
        );
        modalBody.appendChild(progressContainer);

        let successCount = 0;
        let errorCount = 0;

        try {
          // Upload files one by one to show individual progress
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const formData = new FormData();
            formData.append("ruanganId", roomId);
            formData.append("gallery", file);

            // Add progress item
            const progressItem = document.createElement("div");
            progressItem.className = "upload-progress-item";
            progressItem.innerHTML = `
              <div class="progress-info">
                <span class="filename">${file.name}</span>
                <span class="status">Uploading...</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill"></div>
              </div>
            `;
            document
              .getElementById("uploadProgressList")
              .appendChild(progressItem);

            try {
              const response = await fetch(
                `${API_BASE_URL}/ruangan-gallery/upload`,
                {
                  method: "POST",
                  headers: {
                    Authorization: `Bearer ${localStorage.getItem("token")}`,
                  },
                  body: formData,
                }
              );

              if (response.ok) {
                progressItem.querySelector(".status").textContent = "Success";
                progressItem.querySelector(".status").style.color = "#28a745";
                progressItem.querySelector(".progress-fill").style.width =
                  "100%";
                progressItem.querySelector(
                  ".progress-fill"
                ).style.backgroundColor = "#28a745";
                successCount++;
              } else {
                progressItem.querySelector(".status").textContent = "Failed";
                progressItem.querySelector(".status").style.color = "#dc3545";
                progressItem.querySelector(
                  ".progress-fill"
                ).style.backgroundColor = "#dc3545";
                errorCount++;
              }
            } catch (error) {
              progressItem.querySelector(".status").textContent = "Error";
              progressItem.querySelector(".status").style.color = "#dc3545";
              progressItem.querySelector(
                ".progress-fill"
              ).style.backgroundColor = "#dc3545";
              errorCount++;
            }
          }

          // Show final notification
          if (successCount > 0) {
            showNotification(
              "success",
              "Upload Selesai",
              `${successCount} file berhasil diupload${
                errorCount > 0 ? `, ${errorCount} file gagal` : ""
              }`
            );

            // Auto refresh gallery images immediately
            console.log("Refreshing modal gallery...");
            await loadCurrentGalleryImages(roomId);
            console.log("Modal gallery refreshed successfully");

            // Refresh global gallery data dan re-render bangunan
            const buildingId = getUrlParameter("id");
            console.log("Building ID for refresh:", buildingId);
            if (buildingId) {
              console.log("Calling refreshGlobalGalleryData...");
              try {
                const refreshResult = await refreshGlobalGalleryData(
                  buildingId
                );
                console.log("Refresh result:", refreshResult);
                if (refreshResult) {
                  console.log("✅ Global gallery data refreshed successfully");
                } else {
                  console.error("❌ Failed to refresh global gallery data");
                }
              } catch (refreshError) {
                console.error("❌ Error during refresh:", refreshError);
              }
            } else {
              console.warn("No building ID found for refresh");
            }

            // Reset file input and text
            fileInput.value = "";
            document.getElementById("fileText").textContent =
              "Tidak ada file yang dipilih";

            // Hide preview section
            const previewSection = document.getElementById("previewSection");
            if (previewSection) {
              previewSection.style.display = "none";
            }

            // Remove progress container
            progressContainer.remove();

            // Re-enable save button
            saveButton.innerHTML = originalButtonText;
            saveButton.disabled = false;

            // Show additional buttons for adding more files
            const addMoreBtn = document.querySelector(
              "#editGalleryModal .btn-add-more"
            );
            const doneBtn = document.querySelector(
              "#editGalleryModal .btn-done"
            );
            const saveBtn = document.querySelector(
              "#editGalleryModal .btn-save"
            );

            if (addMoreBtn && doneBtn && saveBtn) {
              addMoreBtn.style.display = "inline-block";
              doneBtn.style.display = "inline-block";
              saveBtn.style.display = "none";
            }

            // Show success notification with auto-refresh info
            showNotification(
              "success",
              "Gallery Diperbarui",
              "Gambar baru telah ditambahkan ke gallery"
            );
          } else {
            showNotification(
              "error",
              "Upload Gagal",
              "Semua file gagal diupload"
            );
            progressContainer.remove();
            saveButton.innerHTML = originalButtonText;
            saveButton.disabled = false;
          }
        } catch (error) {
          console.error("Error:", error);
          showNotification(
            "error",
            "Gagal diperbarui",
            "Gagal menambah gambar: " + error.message
          );
          progressContainer.remove();
          saveButton.innerHTML = originalButtonText;
          saveButton.disabled = false;
        }
      }

      // Fungsi untuk menambah gambar gallery (legacy function)
      async function addGalleryImages(roomId) {
        const fileInput = document.getElementById("addGalleryImage");
        const files = fileInput.files;

        if (files.length === 0) {
          return;
        }

        const formData = new FormData();
        formData.append("ruanganId", roomId);
        for (let i = 0; i < files.length; i++) {
          formData.append("gallery", files[i]);
        }

        try {
          const response = await fetch(
            `${API_BASE_URL}/ruangan-gallery/upload`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: formData,
            }
          );

          if (response.ok) {
            // Reload gallery images
            console.log("Refreshing modal gallery (legacy)...");
            loadCurrentGalleryImages(roomId);
            console.log("Modal gallery refreshed successfully (legacy)");

            // Refresh global gallery data dan re-render bangunan
            const buildingId = getUrlParameter("id");
            console.log("Building ID for refresh (legacy):", buildingId);
            if (buildingId) {
              console.log("Calling refreshGlobalGalleryData (legacy)...");
              try {
                const refreshResult = await refreshGlobalGalleryData(
                  buildingId
                );
                console.log("Refresh result (legacy):", refreshResult);
                if (refreshResult) {
                  console.log(
                    "✅ Global gallery data refreshed successfully (legacy)"
                  );
                } else {
                  console.error(
                    "❌ Failed to refresh global gallery data (legacy)"
                  );
                }
              } catch (refreshError) {
                console.error(
                  "❌ Error during refresh (legacy):",
                  refreshError
                );
              }
            } else {
              console.warn("No building ID found for refresh (legacy)");
            }

            // Reset file input
            fileInput.value = "";
          } else {
            throw new Error("Gagal menambah gambar");
          }
        } catch (error) {
          console.error("Error:", error);
          showNotification(
            "error",
            "Gagal diperbarui",
            "Gagal menambah gambar: " + error.message
          );
        }
      }

      // Fungsi untuk menghapus gambar gallery (dengan konfirmasi)
      async function deleteGalleryImage(galleryId, roomId) {
        showConfirmation(
          "Konfirmasi Hapus",
          "Yakin ingin menghapus gambar ini?",
          () => {
            performDeleteGalleryImage(galleryId, roomId);
          }
        );
      }

      // Fungsi untuk menghapus gambar gallery dengan loading indicator
      async function deleteGalleryImageWithLoading(
        galleryId,
        roomId,
        buttonElement
      ) {
        // Disable button and show loading
        const originalButtonHTML = buttonElement.innerHTML;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        buttonElement.disabled = true;
        buttonElement.style.opacity = "0.6";

        try {
          // Direct delete without confirmation (loading indicator provides feedback)
          await performDeleteGalleryImage(galleryId, roomId);
        } finally {
          // Re-enable button
          buttonElement.innerHTML = originalButtonHTML;
          buttonElement.disabled = false;
          buttonElement.style.opacity = "1";
        }
      }

      // Fungsi untuk melakukan penghapusan gambar gallery
      async function performDeleteGalleryImage(galleryId, roomId) {
        try {
          const response = await fetch(
            `${API_BASE_URL}/ruangan-gallery/${galleryId}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );

          if (response.ok) {
            showNotification(
              "success",
              "Gambar Dihapus",
              "Gambar berhasil dihapus dari gallery!"
            );

            // Auto refresh gallery images immediately
            console.log("Refreshing modal gallery (delete)...");
            await loadCurrentGalleryImages(roomId);
            console.log("Modal gallery refreshed successfully (delete)");

            // Refresh global gallery data dan re-render bangunan
            const buildingId = getUrlParameter("id");
            console.log("Building ID for refresh (delete):", buildingId);
            if (buildingId) {
              console.log("Calling refreshGlobalGalleryData (delete)...");
              try {
                const refreshResult = await refreshGlobalGalleryData(
                  buildingId
                );
                console.log("Refresh result (delete):", refreshResult);
                if (refreshResult) {
                  console.log(
                    "✅ Global gallery data refreshed successfully (delete)"
                  );
                } else {
                  console.error(
                    "❌ Failed to refresh global gallery data (delete)"
                  );
                }
              } catch (refreshError) {
                console.error(
                  "❌ Error during refresh (delete):",
                  refreshError
                );
              }
            } else {
              console.warn("No building ID found for refresh (delete)");
            }

            showNotification(
              "success",
              "Gallery Diperbarui",
              "Gallery telah diperbarui setelah penghapusan"
            );
          } else {
            throw new Error("Gagal menghapus gambar");
          }
        } catch (error) {
          console.error("Error:", error);
          showNotification(
            "error",
            "Gagal Dihapus",
            "Gagal menghapus gambar: " + error.message
          );
        }
      }

      // Custom Notification System Functions
      function showNotification(type, title, message) {
        const container = document.getElementById("notificationContainer");

        // Create notification element
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;

        const icon =
          type === "success" ? "fas fa-check-circle" : "fas fa-times-circle";

        notification.innerHTML = `
          <div class="notification-icon">
            <i class="${icon}"></i>
          </div>
          <div class="notification-content">
            <div class="notification-title">${title}</div>
            <div class="notification-message">${message}</div>
          </div>
          <button class="notification-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
          </button>
        `;

        // Add to container
        container.appendChild(notification);

        // Auto hide after 4 seconds
        setTimeout(() => {
          if (container.contains(notification)) {
            notification.style.opacity = "0";
            notification.style.transform = "translateX(-50%) translateY(-100%)";
            setTimeout(() => {
              if (container.contains(notification)) {
                container.removeChild(notification);
              }
            }, 500);
          }
        }, 4000);
      }

      // Custom Confirmation Dialog Functions
      let confirmationCallback = null;

      function showConfirmation(title, message, onConfirm) {
        const modal = document.getElementById("confirmationModal");
        const titleEl = document.getElementById("confirmationTitle");
        const messageEl = document.getElementById("confirmationMessage");

        titleEl.textContent = title;
        messageEl.textContent = message;
        confirmationCallback = onConfirm;

        modal.classList.add("show");
      }

      function hideConfirmation() {
        const modal = document.getElementById("confirmationModal");
        modal.classList.remove("show");
        confirmationCallback = null;
      }

      function confirmAction() {
        if (confirmationCallback) {
          confirmationCallback();
        }
        hideConfirmation();
      }

      // Update confirm button to use the new function
      document.addEventListener("DOMContentLoaded", function () {
        const confirmButton = document.getElementById("confirmButton");
        if (confirmButton) {
          confirmButton.onclick = confirmAction;
        }
      });
    </script>

    <script src="js/list.min.js"></script>
    <script src="js/classie.js"></script>
    <script src="js/main.js"></script>

    <!-- Script untuk mengatur ukuran gambar SVG agar pas dengan container level -->
    <script>
      // Fungsi untuk mengatur ukuran gambar SVG agar pas dengan container level
      function adjustSVGSizeToLevel() {
        // Cari semua level yang sedang aktif
        const activeLevels = document.querySelectorAll(".level");

        activeLevels.forEach((level) => {
          const img = level.querySelector("img");
          if (!img) return;

          // Tunggu gambar selesai dimuat
          if (img.complete) {
            adjustImageSize(img, level);
          } else {
            img.onload = () => adjustImageSize(img, level);
          }
        });
      }

      function adjustImageSize(img, level) {
        // Dapatkan ukuran container level (gunakan computed style untuk ukuran yang lebih akurat)
        const levelStyle = window.getComputedStyle(level);
        const levelWidth = parseFloat(levelStyle.width);
        const levelHeight = parseFloat(levelStyle.height);

        // Dapatkan ukuran asli gambar
        const imgNaturalWidth = img.naturalWidth;
        const imgNaturalHeight = img.naturalHeight;

        if (imgNaturalWidth && imgNaturalHeight && levelWidth && levelHeight) {
          // Hitung aspect ratio
          const imgAspectRatio = imgNaturalWidth / imgNaturalHeight;
          const levelAspectRatio = levelWidth / levelHeight;

          let newWidth, newHeight;

          if (imgAspectRatio > levelAspectRatio) {
            // Gambar lebih lebar, sesuaikan dengan lebar level
            newWidth = levelWidth;
            newHeight = levelWidth / imgAspectRatio;
          } else {
            // Gambar lebih tinggi, sesuaikan dengan tinggi level
            newHeight = levelHeight;
            newWidth = levelHeight * imgAspectRatio;
          }

          // Terapkan ukuran baru ke gambar
          img.style.width = newWidth + "px";
          img.style.height = newHeight + "px";
          img.style.objectFit = "contain";

          // Jika level ini adalah current level, sesuaikan lebar container level
          if (level.classList.contains("level--current")) {
            // Set lebar container level agar sama dengan lebar gambar yang sudah disesuaikan
            level.style.width = newWidth + "px";
            level.style.height = newHeight + "px";
          }
        }
      }

      // Jalankan saat DOM selesai dimuat
      document.addEventListener("DOMContentLoaded", function () {
        // Tunggu sebentar agar level sudah ter-render
        setTimeout(adjustSVGSizeToLevel, 500);

        // Jalankan lagi setelah 1 detik untuk memastikan
        setTimeout(adjustSVGSizeToLevel, 1000);

        // Jalankan lagi setelah 2 detik untuk memastikan semua gambar sudah dimuat
        setTimeout(adjustSVGSizeToLevel, 2000);
      });

      // Jalankan setiap kali ada perubahan pada level
      const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          if (mutation.type === "attributes" || mutation.type === "childList") {
            setTimeout(adjustSVGSizeToLevel, 100);
          }
        });
      });

      // Fungsi untuk mengatur ulang ukuran level current saat level berubah
      function resetCurrentLevelSize() {
        const currentLevel = document.querySelector(".level.level--current");
        if (currentLevel) {
          // Reset ukuran container level current ke ukuran default
          currentLevel.style.width = "";
          currentLevel.style.height = "";

          // Tunggu sebentar lalu sesuaikan lagi
          setTimeout(() => {
            const img = currentLevel.querySelector("img");
            if (img && img.complete) {
              adjustImageSize(img, currentLevel);
            }
          }, 50);
        }
      }

      // Observe perubahan pada container levels
      document.addEventListener("DOMContentLoaded", function () {
        const levelsContainer = document.querySelector(".levels");
        if (levelsContainer) {
          observer.observe(levelsContainer, {
            attributes: true,
            childList: true,
            subtree: true,
          });

          // Observe perubahan class level--current
          const levelObserver = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
              if (
                mutation.type === "attributes" &&
                mutation.attributeName === "class"
              ) {
                const target = mutation.target;
                if (target.classList.contains("level")) {
                  // Jika ada level yang menjadi current atau berhenti menjadi current
                  if (target.classList.contains("level--current")) {
                    setTimeout(() => {
                      const img = target.querySelector("img");
                      if (img && img.complete) {
                        adjustImageSize(img, target);
                      }
                    }, 100);
                  } else {
                    // Jika level berhenti menjadi current, reset ukurannya
                    target.style.width = "";
                    target.style.height = "";
                  }
                }
              }
            });
          });

          // Observe semua level untuk perubahan class
          const allLevels = levelsContainer.querySelectorAll(".level");
          allLevels.forEach((level) => {
            levelObserver.observe(level, {
              attributes: true,
              attributeFilter: ["class"],
            });
          });

          // Fungsi untuk observe level baru yang ditambahkan
          function observeNewLevels() {
            const newLevels = levelsContainer.querySelectorAll(".level");
            newLevels.forEach((level) => {
              // Cek apakah level ini sudah di-observe
              if (!level.hasAttribute("data-observed")) {
                levelObserver.observe(level, {
                  attributes: true,
                  attributeFilter: ["class"],
                });
                level.setAttribute("data-observed", "true");
              }
            });
          }

          // Jalankan observeNewLevels setiap kali ada perubahan childList
          const childObserver = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
              if (mutation.type === "childList") {
                setTimeout(observeNewLevels, 50);
              }
            });
          });

          childObserver.observe(levelsContainer, {
            childList: true,
            subtree: true,
          });
        }
      });

      // Jalankan juga saat window resize
      window.addEventListener("resize", function () {
        setTimeout(adjustSVGSizeToLevel, 100);
      });

      // Fungsi untuk menambah file lagi
      async function addMoreFiles() {
        const fileInput = document.getElementById("addGalleryImage");
        const addMoreBtn = document.querySelector(
          "#editGalleryModal .btn-add-more"
        );
        const doneBtn = document.querySelector("#editGalleryModal .btn-done");
        const saveBtn = document.querySelector("#editGalleryModal .btn-save");

        // Reset file input
        fileInput.value = "";
        document.getElementById("fileText").textContent =
          "Tidak ada file yang dipilih";

        // Hide preview section
        const previewSection = document.getElementById("previewSection");
        if (previewSection) {
          previewSection.style.display = "none";
        }

        // Show save button, hide add more and done buttons
        if (addMoreBtn && doneBtn && saveBtn) {
          addMoreBtn.style.display = "none";
          doneBtn.style.display = "none";
          saveBtn.style.display = "inline-block";
        }

        // Remove any existing progress container
        const progressContainer = document.querySelector(
          ".upload-progress-container"
        );
        if (progressContainer) {
          progressContainer.remove();
        }

        // Auto refresh gallery to show latest images
        const roomId = getCurrentRoomId();
        if (roomId) {
          await loadCurrentGalleryImages(roomId);
        }

        // Focus on file input
        fileInput.click();
      }

      // Helper function to get current room ID from modal
      function getCurrentRoomId() {
        const modal = document.getElementById("editGalleryModal");
        if (modal) {
          const saveButton = modal.querySelector(".btn-save");
          if (saveButton) {
            const onclick = saveButton.getAttribute("onclick");
            if (onclick) {
              const match = onclick.match(/saveGalleryImages\((\d+)\)/);
              if (match) {
                return match[1];
              }
            }
          }
        }
        return null;
      }

      // 2D/2.5D View Toggle Functionality
      function initializeViewToggle() {
        console.log("Initializing view toggle...");
        const viewToggleBtn = document.getElementById("view-toggle-btn");
        const viewToggleText = document.getElementById("view-toggle-text");
        const building = document.querySelector(".building");

        console.log("View toggle elements:", {
          viewToggleBtn,
          viewToggleText,
          building,
        });

        if (!viewToggleBtn || !viewToggleText || !building) {
          console.warn("View toggle elements not found");
          return;
        }

        // Default to 2.5D view (no localStorage check needed)
        building.classList.remove("building--2d");
        viewToggleText.textContent = "2.5D";

        // Ensure All Levels button is enabled by default
        const allLevelsBtn = document.querySelector(
          ".buildingnav__button--all-levels"
        );
        if (allLevelsBtn) {
          allLevelsBtn.style.opacity = "1";
          allLevelsBtn.style.pointerEvents = "auto";
          allLevelsBtn.style.cursor = "pointer";
          allLevelsBtn.style.backgroundColor = "";
          allLevelsBtn.style.color = "";
        }

        // Add click event listener
        viewToggleBtn.addEventListener("click", function () {
          const isCurrently2D = building.classList.contains("building--2d");
          const allLevelsBtn = document.querySelector(
            ".buildingnav__button--all-levels"
          );

          console.log("Current building classes:", building.className);
          console.log("Is currently 2D:", isCurrently2D);

          if (isCurrently2D) {
            // Switch to 2.5D
            building.classList.remove("building--2d");
            viewToggleText.textContent = "2.5D";
            console.log("Switched to 2.5D view");
            console.log("Building classes after switch:", building.className);

            // Re-enable All Levels button
            if (allLevelsBtn) {
              allLevelsBtn.style.opacity = "1";
              allLevelsBtn.style.pointerEvents = "auto";
              allLevelsBtn.style.cursor = "pointer";
              allLevelsBtn.style.backgroundColor = "";
              allLevelsBtn.style.color = "";
              console.log("All Levels button re-enabled");
            }
          } else {
            // Switch to 2D
            building.classList.add("building--2d");
            viewToggleText.textContent = "2D";
            console.log("Switched to 2D view");
            console.log("Building classes after switch:", building.className);

            // Disable All Levels button
            if (allLevelsBtn) {
              allLevelsBtn.style.opacity = "0.5";
              allLevelsBtn.style.pointerEvents = "none";
              allLevelsBtn.style.cursor = "not-allowed";
              allLevelsBtn.style.backgroundColor = "#6c757d";
              allLevelsBtn.style.color = "#adb5bd";
              console.log("All Levels button disabled");
            }
          }

          // Add visual feedback
          viewToggleBtn.style.transform = "scale(1.1)";
          setTimeout(() => {
            viewToggleBtn.style.transform = "scale(1)";
          }, 150);
        });
      }

      // Initialize view toggle when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        // Wait a bit for the building to be rendered
        setTimeout(initializeViewToggle, 1000);
      });

      // Also initialize when building is rendered
      if (typeof window.buildingDetailsInit === "function") {
        const originalInit = window.buildingDetailsInit;
        window.buildingDetailsInit = function () {
          originalInit();
          setTimeout(initializeViewToggle, 500);
        };
      }

      // Try to initialize multiple times to ensure it works
      let initAttempts = 0;
      const maxAttempts = 10;

      function tryInitializeViewToggle() {
        if (initAttempts >= maxAttempts) {
          console.warn(
            "Failed to initialize view toggle after",
            maxAttempts,
            "attempts"
          );
          return;
        }

        const building = document.querySelector(".building");
        const viewToggleBtn = document.getElementById("view-toggle-btn");

        if (building && viewToggleBtn) {
          console.log(
            "Successfully initialized view toggle on attempt",
            initAttempts + 1
          );
          initializeViewToggle();
        } else {
          initAttempts++;
          setTimeout(tryInitializeViewToggle, 500);
        }
      }

      // Start trying to initialize
      setTimeout(tryInitializeViewToggle, 500);

      // Add event listener to prevent clicks on disabled All Levels button
      document.addEventListener("click", function (e) {
        if (e.target.classList.contains("buildingnav__button--all-levels")) {
          const building = document.querySelector(".building");
          if (building && building.classList.contains("building--2d")) {
            e.preventDefault();
            e.stopPropagation();

            // Show user-friendly message
            const message =
              'Tombol "All Levels" hanya tersedia dalam mode 2.5D. Silakan ubah ke mode 2.5D terlebih dahulu.';
            alert(message);

            // Optionally, you could show a more elegant notification here
            console.log(
              "All Levels button clicked while in 2D mode - action prevented"
            );
          }
        }
      });

      // Debug function - manually test 2D view
      window.test2DView = function () {
        const building = document.querySelector(".building");
        if (building) {
          console.log("Testing 2D view...");
          building.classList.add("building--2d");
          console.log("Building classes after adding 2D:", building.className);
          console.log("Building element:", building);

          // Check if CSS is applied
          const levels = building.querySelectorAll(".levels");
          const surroundings = building.querySelectorAll(".surroundings");
          console.log("Levels found:", levels.length);
          console.log("Surroundings found:", surroundings.length);

          if (levels.length > 0) {
            const computedStyle = window.getComputedStyle(levels[0]);
            console.log("Levels transform:", computedStyle.transform);

            // Try to manually apply inline styles as a test
            levels.forEach((level) => {
              level.style.transform = "none";
              level.style.webkitTransform = "none";
            });
          }

          if (surroundings.length > 0) {
            surroundings.forEach((surrounding) => {
              surrounding.style.transform = "none";
              surrounding.style.webkitTransform = "none";
            });
          }

          console.log("Applied inline styles for testing");
        } else {
          console.error("Building element not found");
        }
      };

      // Debug function - manually test 2.5D view
      window.test25DView = function () {
        const building = document.querySelector(".building");
        if (building) {
          console.log("Testing 2.5D view...");
          building.classList.remove("building--2d");
          console.log(
            "Building classes after removing 2D:",
            building.className
          );
        } else {
          console.error("Building element not found");
        }
      };

      // Debug function - check CSS loading
      window.checkCSS = function () {
        console.log("Checking CSS loading...");

        // Check if our CSS file is loaded
        const styleSheets = Array.from(document.styleSheets);
        const ourCSS = styleSheets.find(
          (sheet) => sheet.href && sheet.href.includes("style.css")
        );

        if (ourCSS) {
          console.log("Our CSS file is loaded:", ourCSS.href);

          // Try to access CSS rules
          try {
            const rules = ourCSS.cssRules || ourCSS.rules;
            console.log("CSS rules count:", rules ? rules.length : "No rules");

            // Look for our 2D styles
            if (rules) {
              for (let i = 0; i < rules.length; i++) {
                const rule = rules[i];
                if (
                  rule.selectorText &&
                  rule.selectorText.includes("building--2d")
                ) {
                  console.log("Found 2D CSS rule:", rule.selectorText);
                }
              }
            }
          } catch (e) {
            console.error("Error accessing CSS rules:", e);
          }
        } else {
          console.error("Our CSS file not found in loaded stylesheets");
        }
      };

      // Debug function - inspect DOM structure
      window.inspectDOM = function () {
        console.log("Inspecting DOM structure...");

        const building = document.querySelector(".building");
        if (building) {
          console.log("Building element:", building);
          console.log("Building classes:", building.className);

          const levels = building.querySelectorAll(".levels");
          console.log("Levels container:", levels);

          if (levels.length > 0) {
            const levelElements = levels[0].querySelectorAll(".level");
            console.log("Level elements found:", levelElements.length);

            levelElements.forEach((level, index) => {
              console.log(`Level ${index + 1}:`, level);
              console.log(`Level ${index + 1} classes:`, level.className);
              console.log(
                `Level ${index + 1} transform:`,
                level.style.transform
              );
            });
          }

          const surroundings = building.querySelectorAll(".surroundings");
          console.log("Surroundings:", surroundings);
        } else {
          console.error("Building element not found");
        }
      };
    </script>
  </body>
</html>
